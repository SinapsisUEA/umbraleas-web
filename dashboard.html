<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sinapsis | B√∫nker de Inteligencia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #05070a; --panel: #0d1117; --blue: #58a6ff; --orange: #f0883e; --silver: #c9d1d9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--silver); margin: 0; padding: 20px; }
        header { border-bottom: 2px solid var(--blue); padding-bottom: 10px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .stat-card { background: var(--panel); padding: 25px; border-radius: 10px; border: 1px solid #30363d; min-height: 450px; }
        h2 { color: var(--orange); font-size: 1.1em; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-refresh { background: var(--blue); color: #000; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #debug-info { margin-top: 20px; font-size: 0.8em; color: #8b949e; }
    </style>
</head>
<body>

<header>
    <div>
        <h1 style="margin:0; color:var(--blue); letter-spacing: 2px;">B√öNKER DE INTELIGENCIA</h1>
        <p style="margin:0; font-size: 0.9em; color: var(--orange);">M√©tricas Asim√©tricas para el Simposio</p>
    </div>
    <button class="btn-refresh" onclick="cargarMetricas()">SINCRONIZAR DATOS</button>
</header>

<div style="margin-bottom: 20px; display: flex; gap: 20px; align-items: center; background: var(--panel); padding: 15px; border-radius: 10px; border: 1px solid #30363d;">
    <label style="color: var(--blue); font-weight: bold;">SELECCIONAR FOCO DE AN√ÅLISIS:</label>
    <select id="selectorArticulo" onchange="actualizarFocoArticulo()" style="background: #111; color: #fff; padding: 8px; border-radius: 5px; border: 1px solid var(--blue); width: 300px;">
        <option value="todos">Todos los art√≠culos (Vista Global)</option>
    </select>
</div>

<div class="grid-stats">
    <div class="stat-card">
        <h2>Impacto por Art√≠culo (Sinapsis Totales)</h2>
        <div style="position: relative; height:350px;">
            <canvas id="chartImpacto"></canvas>
        </div>
    </div>

    <div class="stat-card">
        <h2>Naturaleza del Debate (Reacciones)</h2>
        <div style="position: relative; height:350px;">
            <canvas id="chartTipos"></canvas>
        </div>
    </div>
</div>

<div class="stat-card" style="margin-top: 20px; width: 100%;">
    <h2>Hallazgos Cr√≠ticos para el Simposio (Fricci√≥n y Disenso)</h2>
    <table id="tablaHallazgos" style="width: 100%; border-collapse: collapse; color: var(--silver); text-align: left;">
        <thead>
            <tr style="border-bottom: 2px solid var(--blue); color: var(--orange);">
                <th style="padding: 10px;">Art√≠culo</th>
                <th style="padding: 10px;">üí° Inter√©s</th>
                <th style="padding: 10px;">‚öñÔ∏è Debate</th>
                <th style="padding: 10px;">‚ùì Duda</th>
                <th style="padding: 10px;">Prioridad Simposio</th>
            </tr>
        </thead>
        <tbody id="cuerpoTabla">
            </tbody>
    </table>
</div>

<div id="debug-info">Estado del B√∫nker: Esperando conexi√≥n...</div>

<script>
    const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let chart1 = null;
    let chart2 = null;

    let datosGlobales = []; // Memoria t√°ctica

    async function cargarMetricas() {
        document.getElementById('debug-info').innerText = "Sincronizando con el umbral...";
        try {
            const { data: reacciones, error } = await _supabase
                .from('sinapsis_reacciones')
                .select('tipo_reaccion, articulos(Titulo)');

            if (error) throw error;
            datosGlobales = reacciones;

            // Llenar el selector de art√≠culos la primera vez
            const selector = document.getElementById('selectorArticulo');
            const titulos = [...new Set(reacciones.map(r => r.articulos.Titulo))];
            selector.innerHTML = '<option value="todos">Todos los art√≠culos (Vista Global)</option>';
            titulos.forEach(t => {
                selector.innerHTML += `<option value="${t}">${t}</option>`;
            });

            procesarYMostrar('todos');
        } catch (err) {
            document.getElementById('debug-info').innerText = "Error de conexi√≥n.";
        }
    }

    function procesarYMostrar(filtro) {
        const conteoArticulos = {};
        const conteoTipos = { 'üí°': 0, '‚öñÔ∏è': 0, '‚ùì': 0 };
        const tablaResumen = {};

        datosGlobales.forEach(r => {
            const titulo = r.articulos ? r.articulos.Titulo : "Desconocido";
            
            // L√≥gica para la tabla global
            if (!tablaResumen[titulo]) tablaResumen[titulo] = { 'üí°': 0, '‚öñÔ∏è': 0, '‚ùì': 0 };
            tablaResumen[titulo][r.tipo_reaccion]++;

            // L√≥gica para los gr√°ficos
            if (filtro === 'todos' || filtro === titulo) {
                conteoArticulos[titulo] = (conteoArticulos[titulo] || 0) + 1;
                conteoTipos[r.tipo_reaccion]++;
            }
        });

        dibujarGraficos(conteoArticulos, conteoTipos);
        actualizarTabla(tablaResumen);
        document.getElementById('debug-info').innerText = `An√°lisis para: ${filtro}`;
    }

    function actualizarFocoArticulo() {
        const seleccion = document.getElementById('selectorArticulo').value;
        procesarYMostrar(seleccion);
    }

    function actualizarTabla(resumen) {
        const cuerpo = document.getElementById('cuerpoTabla');
        cuerpo.innerHTML = "";
        
        Object.keys(resumen).forEach(titulo => {
            const d = resumen[titulo];
            const friccion = d['‚öñÔ∏è'] + d['‚ùì'];
            const prioridad = friccion > 5 ? "ALTA (Conflictivo)" : "Normal";
            
            cuerpo.innerHTML += `
                <tr style="border-bottom: 1px solid #30363d;">
                    <td style="padding: 10px;">${titulo}</td>
                    <td style="padding: 10px;">${d['üí°']}</td>
                    <td style="padding: 10px; color: var(--blue);">${d['‚öñÔ∏è']}</td>
                    <td style="padding: 10px; color: var(--orange);">${d['‚ùì']}</td>
                    <td style="padding: 10px;">${prioridad}</td>
                </tr>
            `;
        });
    }

    // Carga inicial
    cargarMetricas();
</script>
</body>
</html>
