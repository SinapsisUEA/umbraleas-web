<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sinapsis | B칰nker de Inteligencia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --bg: #05070a; --panel: #0d1117; --blue: #58a6ff; --orange: #f0883e; --silver: #c9d1d9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--silver); margin: 0; padding: 20px; }
        
        header { border-bottom: 2px solid var(--blue); padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { color: var(--blue); font-size: 1.5em; letter-spacing: 2px; }

        .grid-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--panel); padding: 20px; border-radius: 8px; border: 1px solid #30363d; }
        
        .list-container { max-height: 500px; overflow-y: auto; margin-top: 15px; }
        .item-data { border-bottom: 1px solid #222; padding: 12px 0; font-size: 0.9em; }
        
        .msg-box { background: rgba(88, 166, 255, 0.03); border-left: 3px solid var(--orange); padding: 10px; margin-bottom: 10px; }
        .msg-meta { font-size: 0.75em; color: var(--blue); margin-bottom: 5px; text-transform: uppercase; }

        .btn-report { background: var(--orange); color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        
        /* Estilos para PDF */
        #header-pdf { display: none; text-align: center; margin-bottom: 30px; }
    </style>
</head>
<body>

<div id="header-pdf">
    <h1 style="color:#000; font-size: 2.5em;">REPORTE ESTRAT칄GICO SINAPSIS</h1>
    <p style="color:#333;">Inteligencia de Red y Capital Social | Generado: <span id="pdf-fecha"></span></p>
    <hr>
</div>

<header>
    <h1><i class="fas fa-shield-alt"></i> B칔NKER DE INTELIGENCIA</h1>
    <div>
        <button class="btn-report" onclick="exportarPDF()">GENERAR REPORTE PDF</button>
    </div>
</header>

<div class="grid-stats">
    <div class="stat-card">
        <h2 style="color:var(--orange); font-size: 1em; border-bottom: 1px solid #333; padding-bottom: 10px;">
            <i class="fas fa-users"></i> REGISTRO DE ACTORES (SIMPOSIO)
        </h2>
        <div id="lista-inscritos" class="list-container">
            <p>Sincronizando capital social...</p>
        </div>
    </div>

    <div class="stat-card">
        <h2 style="color:var(--blue); font-size: 1em; border-bottom: 1px solid #333; padding-bottom: 10px;">
            <i class="fas fa-comments"></i> INTERVENCIONES Y TESIS RECIBIDAS
        </h2>
        <div id="lista-mensajes" class="list-container">
            <p>Escaneando di치logos cr칤ticos...</p>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    async function actualizarBunker() {
        console.log("Iniciando actualizaci칩n de mando...");

        // 1. OBTENER MENSAJES (Sincronizado con art칤culo_id)
        const { data: mensajes, error: errM } = await _supabase
            .from('sinapsis_reacciones')
            .select('*, articulos:art칤culo_id(Titulo)')
            .eq('tipo_reaccion', '游눫')
            .order('id', { ascending: false });

        if (mensajes) {
            document.getElementById('lista-mensajes').innerHTML = mensajes.map(m => `
                <div class="msg-box">
                    <div class="msg-meta">ORIGEN: ${m.articulos?.Titulo || 'Referencia Externa'}</div>
                    <div style="color:#d1d5db;">${m.comentario_texto.replace(/\|/g, '<br>')}</div>
                </div>
            `).join('');
        }

        // 2. OBTENER INSCRITOS (Capital Social)
        const { data: inscritos, error: errI } = await _supabase
            .from('sinapsis_registros')
            .select('*')
            .order('id', { ascending: false });

        if (inscritos) {
            document.getElementById('lista-inscritos').innerHTML = inscritos.map(i => `
                <div class="item-data">
                    <strong style="color:var(--orange);">${i.nombre}</strong><br>
                    <small style="color:var(--blue);">${i.institucion || 'Independiente'}</small> | 
                    <small style="color:#666;">${i.email}</small>
                </div>
            `).join('');
        }
    }

    function exportarPDF() {
        document.getElementById('pdf-fecha').innerText = new Date().toLocaleString();
        const header = document.getElementById('header-pdf');
        header.style.display = 'block';

        const opt = {
            margin: 10,
            filename: 'REPORTE_INTELIGENCIA_SINAPSIS.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, backgroundColor: '#ffffff' },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Cambiamos temporalmente el color de fondo para el PDF (blanco para legibilidad)
        document.body.style.background = "#fff";
        document.body.style.color = "#000";

        html2pdf().set(opt).from(document.body).save().then(() => {
            // Restaurar ambiente B칰nker
            document.body.style.background = "#05070a";
            document.body.style.color = "#c9d1d9";
            header.style.display = 'none';
        });
    }

    // Ejecuci칩n inicial
    actualizarBunker();
    // Auto-actualizaci칩n cada 30 segundos
    setInterval(actualizarBunker, 30000);
</script>

</body>
</html>
