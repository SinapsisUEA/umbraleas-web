<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sinapsis | B√∫nker de Inteligencia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --bg: #05070a; --panel: #0d1117; --blue: #58a6ff; --orange: #f0883e; --silver: #c9d1d9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--silver); margin: 0; padding: 20px; }
        header { border-bottom: 2px solid var(--blue); padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .stat-card { background: var(--panel); padding: 25px; border-radius: 10px; border: 1px solid #30363d; min-height: 550px; display: flex; flex-direction: column; }
        .filter-bar { background: var(--panel); padding: 15px; border-radius: 10px; border: 1px solid var(--blue); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; }
        select { background: #111; color: #fff; border: 1px solid var(--blue); padding: 8px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th { border-bottom: 2px solid var(--blue); color: var(--orange); padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #30363d; }
    </style>
</head>
<body>

<header>
    <h1>B√öNKER DE INTELIGENCIA</h1>
    <button style="background:var(--blue); border:none; padding:10px; cursor:pointer; font-weight:bold;" onclick="cargarMetricas()">RECARGAR DATOS<button style="background:var(--orange); border:none; padding:10px; margin-left:10px; cursor:pointer; font-weight:bold; color:#000;" onclick="exportarPDF()">DESCARGAR REPORTE CR√çTICO</button>
</header>

<div class="filter-bar">
    <label>FOCO DE AN√ÅLISIS:</label>
    <select id="selectorArticulo" onchange="actualizarFocoArticulo()">
        <option value="todos">Cargando art√≠culos...</option>
    </select>
</div>

<div class="grid-stats">
    <div class="stat-card">
        <h2>Impacto por Art√≠culo</h2>
        <div style="height:350px;"><canvas id="chartImpacto"></canvas></div>
    </div>
    <div class="stat-card">
        <h2>Naturaleza del Debate</h2>
        <div style="height:350px;"><canvas id="chartTipos"></canvas></div>
    </div>
</div>

<div class="stat-card" style="margin-top:20px;">
    <h2>Hallazgos Cr√≠ticos para el Simposio</h2>
    <table>
        <thead>
            <tr>
                <th>Art√≠culo</th>
                <th>Autor</th>
                <th>üí° Inter√©s</th>
                <th>‚öñÔ∏è Debate</th>
                <th>‚ùì Duda</th>
                <th>Prioridad</th>
                <th>Acci√≥n Asim√©trica</th>
            </tr>
        </thead>
        <tbody id="cuerpoTabla"></tbody>
    </table>
</div>

<div id="seccionControversia" class="stat-card" style="margin-top:20px; display:none; border: 1px solid var(--orange);">
    <h2 style="color:var(--orange)">An√°lisis de Tesis en Conflicto</h2>
    <div id="listaParrafosCriticos"></div>
</div>

<div id="debug-info" style="margin-top:20px; color:var(--orange);">Estado: Iniciando...</div>

<script>
    const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co'; 
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let datosGlobales = [];
    let chart1, chart2;

    async function cargarMetricas() {
        const debug = document.getElementById('debug-info');
        debug.innerText = "Conectando con la base de datos...";
        try {
           const { data, error } = await _supabase.from('sinapsis_reacciones').select('tipo_reaccion, articulos(id, Titulo, Autor)');
            if (error) throw error;
            datosGlobales = data;
            const selector = document.getElementById('selectorArticulo');
            const titulos = [...new Set(data.map(r => r.articulos?.Titulo).filter(t => t))];
            selector.innerHTML = '<option value="todos">Vista General (Todos)</option>';
            titulos.forEach(t => selector.innerHTML += `<option value="${t}">${t}</option>`);
            procesarYMostrar('todos');
            debug.innerText = "Conexi√≥n exitosa. Datos sincronizados.";
        } catch (err) {
            debug.innerText = "Error de conexi√≥n: " + err.message;
        }
    }

    function procesarYMostrar(filtro) {
        const conteoArt = {};
        const conteoTipos = { 'üí°': 0, '‚öñÔ∏è': 0, '‚ùì': 0 };
        const resumen = {};
        datosGlobales.forEach(r => {
            const t = r.articulos?.Titulo || "Sin T√≠tulo";
            const aut = r.articulos?.Autor || "An√≥nimo";
            if (!resumen[t]) resumen[t] = { 'üí°': 0, '‚öñÔ∏è': 0, '‚ùì': 0, autor: aut };
            resumen[t][r.tipo_reaccion]++;
            if (filtro === 'todos' || filtro === t) {
                conteoArt[t] = (conteoArt[t] || 0) + 1;
                conteoTipos[r.tipo_reaccion]++;
            }
        });
        dibujarGraficos(conteoArt, conteoTipos);
        actualizarTabla(resumen);
    }

    function dibujarGraficos(articulos, tipos) {
        if (chart1) chart1.destroy();
        if (chart2) chart2.destroy();
        chart1 = new Chart(document.getElementById('chartImpacto'), {
            type: 'bar',
            data: { labels: Object.keys(articulos), datasets: [{ label: 'Reacciones', data: Object.values(articulos), backgroundColor: '#58a6ff' }] },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                scales: { 
                    x: { ticks: { color: '#c9d1d9', autoSkip: false, maxRotation: 90, minRotation: 45, font: { size: 11 } }, grid: { display: false } },
                    y: { beginAtZero: true, ticks: { color: '#c9d1d9' }, grid: { color: '#30363d' } }
                },
                plugins: { legend: { display: false } }
            }
        });
        chart2 = new Chart(document.getElementById('chartTipos'), {
            type: 'doughnut',
            data: { labels: ['Inter√©s', 'Debate', 'Duda'], datasets: [{ data: [tipos['üí°'], tipos['‚öñÔ∏è'], tipos['‚ùì']], backgroundColor: ['#f0883e', '#58a6ff', '#8b949e'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#c9d1d9' } } } }
        });
    }

    function actualizarTabla(resumen) {
        const cuerpo = document.getElementById('cuerpoTabla');
        cuerpo.innerHTML = Object.keys(resumen).map(t => {
            const d = resumen[t];
            const tieneDisenso = (d['‚öñÔ∏è'] + d['‚ùì'] > 3);
            const prioridad = tieneDisenso ? '<b style="color:var(--orange)">ALTA - DISENSO</b>' : 'Baja';
            const botonAccion = tieneDisenso ? 
                `<button onclick="generarInvitacion('${t}', '${d.autor}', ${d['‚ùì']}, ${d['‚öñÔ∏è']})" style="background:var(--blue); color:#000; border:none; padding:5px 10px; cursor:pointer; font-weight:bold; border-radius:3px;">CONVOCAR</button>` : '---';
            return `<tr><td>${t}</td><td style="color:var(--blue)">${d.autor}</td><td>${d['üí°']}</td><td>${d['‚öñÔ∏è']}</td><td>${d['‚ùì']}</td><td>${prioridad}</td><td>${botonAccion}</td></tr>`;
        }).join('');
    }

    function generarInvitacion(titulo, autor, dudas, debates) {
        const total = dudas + debates;
        const asunto = encodeURIComponent(`Convocatoria Simposio: ${titulo}`);
        const cuerpo = encodeURIComponent(`Estimado(a) ${autor},\n\nSu tesis "${titulo}" ha generado ${total} puntos de disenso cr√≠tico. Lo convocamos al Simposio para defender sus planteamientos.\n\nAtentamente,\nCentro Sinapsis.`);
        window.location.href = `mailto:?subject=${asunto}&body=${cuerpo}`;
    }

    function actualizarFocoArticulo() {
        const seleccion = document.getElementById('selectorArticulo').value;
        procesarYMostrar(seleccion);
        if (seleccion !== 'todos') { mostrarDetalleControversia(seleccion); } 
        else { document.getElementById('seccionControversia').style.display = 'none'; }
    }

    async function mostrarDetalleControversia(titulo) {
        const seccion = document.getElementById('seccionControversia');
        const lista = document.getElementById('listaParrafosCriticos');
        seccion.style.display = 'block';
        lista.innerHTML = "Analizando nudos cr√≠ticos...";
        try {
            const { data: art } = await _supabase.from('articulos').select('id, Contenido').eq('Titulo', titulo).single();
            const parrafos = art.Contenido.split('\n');
            const { data: reac } = await _supabase.from('sinapsis_reacciones').select('parrafo_index, tipo_reaccion, comentario_texto').eq('art√≠culo_id', art.id).in('tipo_reaccion', ['‚öñÔ∏è', '‚ùì']);
            const mapa = reac.reduce((acc, r) => {
                if (!acc[r.parrafo_index]) acc[r.parrafo_index] = { count: 0, comentarios: [] };
                acc[r.parrafo_index].count++;
                if (r.comentario_texto) acc[r.parrafo_index].comentarios.push(r.comentario_texto);
                return acc;
            }, {});
            lista.innerHTML = "";
            Object.keys(mapa).forEach(idx => {
                const p = mapa[idx];
                lista.innerHTML += `<div style="border-left:4px solid var(--orange); padding:15px; margin-bottom:10px; background:rgba(255,255,255,0.05)">
                    <p><i>"${parrafos[idx] || '...'}"</i></p>
                    <small>Se√±ales: ${p.count} | Argumentos: ${p.comentarios.join(' // ') || 'Sin texto'}</small>
                </div>`;
            });
        } catch (e) { lista.innerHTML = "No hay detalles de controversia registrados."; }
    }

function exportarPDF() {
    const debug = document.getElementById('debug-info');
    debug.innerText = "Generando documento de inteligencia...";

    // Seleccionamos todo el cuerpo del b√∫nker
    const elemento = document.body;

    // Configuraci√≥n del "Documento de Mando"
    const opciones = {
        margin:       10,
        filename:     'Reporte_Sinapsis_Simposio.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, backgroundColor: '#05070a' }, // Mantenemos el modo oscuro
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' } // Horizontal para que quepa la tabla
    };

    // Ocultar botones temporalmente para que no salgan en el PDF
    const botones = document.querySelectorAll('button, select');
    botones.forEach(b => b.style.visibility = 'hidden');

    html2pdf().set(opciones).from(elemento).save().then(() => {
        botones.forEach(b => b.style.visibility = 'visible');
        debug.innerText = "Reporte exportado con √©xito.";
    });
}

    window.onload = cargarMetricas;
</script>
</body>
</html>
