<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√∫nker de Inteligencia - SINAPSIS</title>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg: #0a0c10;
            --card: #161b22;
            --blue: #58a6ff;
            --orange: #f0883e;
            --red: #ff4444;
            --green: #2ea043;
            --silver: #c9d1d9;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--silver);
            margin: 0;
            padding: 20px;
        }
        
        .bunker-header {
            background: linear-gradient(135deg, #000 0%, #1a1f29 100%);
            border-bottom: 3px solid var(--orange);
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .bunker-header h1 {
            color: var(--orange);
            font-size: 2.5em;
            margin: 0;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .bunker-header h2 {
            color: var(--blue);
            font-size: 1.2em;
            margin: 10px 0 0;
            font-weight: 300;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .dashboard-card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #30363d;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            border-color: var(--blue);
        }
        
        .card-title {
            color: var(--orange);
            border-bottom: 2px solid;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .card-full-width {
            grid-column: 1 / -1;
        }
        
        .card-tall {
            grid-row: span 2;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #30363d;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--blue);
            margin: 10px 0;
        }
        
        .stat-label {
            color: var(--silver);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .reaction-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            margin: 2px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        /* CLASES CORREGIDAS */
        .badge-Interesante { background: rgba(88, 166, 255, 0.2); color: var(--blue); border: 1px solid var(--blue); }
        .badge-Debatible { background: rgba(240, 136, 62, 0.2); color: var(--orange); border: 1px solid var(--orange); }
        .badge-Duda { background: rgba(201, 209, 217, 0.2); color: var(--silver); border: 1px solid var(--silver); }
        
        .article-selector {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #30363d;
            color: white;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 1em;
        }
        
        .intervention-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .intervention-item {
            background: rgba(255,255,255,0.03);
            border-left: 4px solid var(--blue);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s;
        }
        
        .intervention-item:hover {
            background: rgba(255,255,255,0.07);
            border-left-color: var(--orange);
        }
        
        .intervention-author {
            color: var(--orange);
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .intervention-text {
            margin: 10px 0;
            line-height: 1.5;
            color: #e6edf3;
        }
        
        .intervention-meta {
            font-size: 0.85em;
            color: #8b949e;
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .priority-high { color: var(--red); font-weight: bold; }
        .priority-medium { color: var(--orange); }
        .priority-low { color: var(--silver); }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .topic-bubble {
            background: linear-gradient(135deg, rgba(88,166,255,0.1) 0%, rgba(240,136,62,0.1) 100%);
            border: 1px solid var(--blue);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .topic-bubble:hover {
            background: linear-gradient(135deg, rgba(88,166,255,0.2) 0%, rgba(240,136,62,0.2) 100%);
            transform: scale(1.02);
        }
        
        .topic-title {
            color: var(--blue);
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .topic-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: var(--silver);
        }
        
        .btn-generate-pdf {
            background: var(--orange);
            color: black;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            font-size: 1.1em;
            transition: background 0.3s;
        }
        
        .btn-generate-pdf:hover {
            background: #ff9c55;
        }
        
        .alert-box {
            background: rgba(240, 136, 62, 0.1);
            border: 1px solid var(--orange);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            color: var(--orange);
        }
        
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bunker-header">
        <h1>üõ°Ô∏è B√öNKER DE INTELIGENCIA</h1>
        <h2>SIMPOSIO SINAPSIS 2025 - GEOPOL√çTICA DEL PENSAMIENTO CR√çTICO</h2>
        <p>Unidad de Inteligencia de Datos - Reporte de Disenso</p>
    </div>
    
    <div class="dashboard-grid">
        <!-- Tarjeta 1: Impacto General -->
        <div class="dashboard-card card-tall">
            <h3 class="card-title">üìä IMPACTO POR ART√çCULO</h3>
            
            <select class="article-selector" id="articleSelector" onchange="cargarDatosArticulo()">
                <option value="all">üìà TODOS LOS ART√çCULOS (Vista Consolidada)</option>
                <!-- Los art√≠culos se cargar√°n din√°micamente -->
            </select>
            
            <div class="chart-container">
                <canvas id="impactChart"></canvas>
            </div>
            
            <div class="stats-grid" id="globalStats">
                <!-- Estad√≠sticas globales se cargar√°n aqu√≠ -->
            </div>
        </div>
        
        <!-- Tarjeta 2: Naturaleza de las Reacciones -->
        <div class="dashboard-card">
            <h3 class="card-title">üéØ NATURALEZA DE LAS REACCIONES</h3>
            
            <div class="chart-container">
                <canvas id="DebatibleChart"></canvas>
            </div>
            
            <div id="reactionDetails">
                <!-- Detalles de reacciones por tipo -->
            </div>
        </div>
        
        <!-- Tarjeta 3: Hallazgos Cr√≠ticos -->
        <div class="dashboard-card">
            <h3 class="card-title">‚ö†Ô∏è HALLAZGOS CR√çTICOS</h3>
            
            <div id="criticalFindings">
                <!-- Hallazgos cr√≠ticos se cargar√°n aqu√≠ -->
            </div>
            
            <div class="alert-box">
                <strong>üéØ NUDOS CR√çTICOS (DISENSO)</strong>
                <p id="nudosCriticos">Cargando an√°lisis de disenso...</p>
            </div>
        </div>
        
        <!-- Tarjeta 4: Intervenciones de Lectores -->
        <div class="dashboard-card card-full-width">
            <h3 class="card-title">üì® BUZ√ìN DE INTERACCI√ìN</h3>
            <p>Di√°logos cr√≠ticos con autores - Base para temas del simposio</p>
            
            <div class="intervention-list" id="interventionList">
                <!-- Las intervenciones se cargar√°n aqu√≠ -->
            </div>
        </div>
        
        <!-- Tarjeta 5: Temas Emergentes para el Simposio -->
        <div class="dashboard-card card-full-width">
            <h3 class="card-title">üéôÔ∏è TEMAS EMERGENTES - SIMPOSIO 2025</h3>
            <p>Temas detectados a partir de las intervenciones de lectores</p>
            
            <div id="emergingTopics">
                <!-- Temas emergentes se cargar√°n aqu√≠ -->
            </div>
            
            <button class="btn-generate-pdf" onclick="generarReportePDF()">
                üìÑ GENERAR REPORTE ESTRAT√âGICO (PDF)
            </button>
        </div>
    </div>
    
    <script>
        // ==================== CONFIGURACI√ìN SUPABASE ====================
        const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        
        // Variables globales
        let articulos = [];
        let reacciones = [];
        let intervenciones = [];
        let temasEmergentes = [];
        let chartImpacto = null;
        let chartDebatible = null;
        let articuloSeleccionado = 'all';
        
        // ==================== INICIALIZACI√ìN ====================
        window.onload = async () => {
            console.log('üõ°Ô∏è Iniciando B√∫nker de Inteligencia...');
            await cargarTodosLosDatos();
            inicializarSelectArticulos();
            renderizarDashboard();
        };
        
        // ==================== FUNCIONES DE CARGA DE DATOS ====================
        async function cargarTodosLosDatos() {
            try {
                // 1. Cargar art√≠culos
                const { data: articulosData, error: errorArticulos } = await _supabase
                    .from('articulos')
                    .select('*')
                    .order('id', { ascending: false });
                
                if (errorArticulos) throw errorArticulos;
                articulos = articulosData || [];
                console.log(`‚úÖ ${articulos.length} art√≠culos cargados`);
                
                // 2. Cargar reacciones
                const { data: reaccionesData, error: errorReacciones } = await _supabase
                    .from('sinapsis_reacciones')
                    .select('*');
                
                if (errorReacciones) throw errorReacciones;
                reacciones = reaccionesData || [];
                console.log(`‚úÖ ${reacciones.length} reacciones cargadas`);
                
                // 3. Cargar intervenciones (dashboard_intervenciones)
                const { data: intervencionesData, error: errorIntervenciones } = await _supabase
                    .from('dashboard_intervenciones')
                    .select('*')
                    .order('fecha', { ascending: false });
                
                if (errorIntervenciones) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ tabla dashboard_intervenciones, usando sinapsis_reacciones');
                    // Si no existe la tabla, usar reacciones tipo TESIS
                    intervenciones = reacciones.filter(r => r.tipo_reaccion.includes('üí¨'));
                } else {
                    intervenciones = intervencionesData || [];
                }
                console.log(`‚úÖ ${intervenciones.length} intervenciones cargadas`);
                
                // 4. Cargar temas emergentes (si existe la tabla)
                try {
                    const { data: temasData, error: errorTemas } = await _supabase
                        .from('simposio_temas')
                        .select('*')
                        .order('intervenciones_count', { ascending: false });
                    
                    if (!errorTemas) {
                        temasEmergentes = temasData || [];
                        console.log(`‚úÖ ${temasEmergentes.length} temas emergentes cargados`);
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Tabla simposio_temas no disponible');
                    temasEmergentes = [];
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                alert('Error al cargar datos del b√∫nker: ' + error.message);
            }
        }
        
        // ==================== FUNCIONES DE RENDERIZADO ====================
        function inicializarSelectArticulos() {
            const selector = document.getElementById('articleSelector');
            
            // Limpiar opciones excepto la primera
            while (selector.options.length > 1) {
                selector.remove(1);
            }
            
            // Agregar cada art√≠culo
            articulos.forEach(art => {
                const option = document.createElement('option');
                option.value = art.id;
                option.textContent = `${art.titulo} - ${art.autor}`;
                selector.appendChild(option);
            });
        }
        
        function cargarDatosArticulo() {
            articuloSeleccionado = document.getElementById('articleSelector').value;
            renderizarDashboard();
        }
        
        function renderizarDashboard() {
            renderizarEstadisticasGlobales();
            renderizarGraficoImpacto();
            renderizarGraficoDebatible();
            renderizarHallazgosCriticos();
            renderizarIntervenciones();
            renderizarTemasEmergentes();
        }
        
        function renderizarEstadisticasGlobales() {
            const statsContainer = document.getElementById('globalStats');
            
            // Filtrar reacciones seg√∫n selecci√≥n
            let reaccionesFiltradas = reacciones;
            if (articuloSeleccionado !== 'all') {
                reaccionesFiltradas = reacciones.filter(r => r.articulo_id == articuloSeleccionado);
            }
            
            // Contar por tipo (Usando los Emojis como fuente de verdad)
            const Interesante = reaccionesFiltradas.filter(r => r.tipo_reaccion === 'üí°').length;
            const Debatible = reaccionesFiltradas.filter(r => r.tipo_reaccion === '‚öñÔ∏è').length;
            const Duda = reaccionesFiltradas.filter(r => r.tipo_reaccion === '‚ùì').length;
            const tesis = reaccionesFiltradas.filter(r => r.tipo_reaccion.includes('üí¨')).length;
            const total = Interesante + Debatible + Duda;
            
            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Total Reacciones</div>
                    <div class="stat-number">${total}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">üí° Interesante</div>
                    <div class="stat-number">${Interesante}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">‚öñÔ∏è Debatible</div>
                    <div class="stat-number">${Debatible}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">‚ùì Duda</div>
                    <div class="stat-number">${Duda}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">üìù Tesis</div>
                    <div class="stat-number">${tesis}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">üìä Engagement</div>
                    <div class="stat-number">${total + tesis}</div>
                </div>
            `;
        }
        
        function renderizarGraficoImpacto() {
            const ctx = document.getElementById('impactChart').getContext('2d');
            
            // Preparar datos seg√∫n selecci√≥n
            let labels = [];
            let datosInteresante = [];
            let datosDebatible = [];
            let datosDuda = [];
            
            if (articuloSeleccionado === 'all') {
                // Para todos los art√≠culos, mostrar los 10 m√°s activos
                const articulosConReacciones = articulos.map(art => {
                    const reaccionesArt = reacciones.filter(r => r.articulo_id === art.id);
                    return {
                        ...art,
                        Interesante: reaccionesArt.filter(r => r.tipo_reaccion === 'üí°').length,
                        Debatible: reaccionesArt.filter(r => r.tipo_reaccion === '‚öñÔ∏è').length,
                        Duda: reaccionesArt.filter(r => r.tipo_reaccion === '‚ùì').length,
                        total: reaccionesArt.length
                    };
                }).sort((a, b) => b.total - a.total).slice(0, 10);
                
                labels = articulosConReacciones.map(a => a.titulo.substring(0, 20) + '...');
                datosInteresante = articulosConReacciones.map(a => a.Interesante);
                datosDebatible = articulosConReacciones.map(a => a.Debatible);
                datosDuda = articulosConReacciones.map(a => a.Duda);
            } else {
                // Para un art√≠culo espec√≠fico, mostrar por d√≠a/semana
                const art = articulos.find(a => a.id == articuloSeleccionado);
                labels = ['Interesante', 'Debatible', 'Duda'];
                const reaccionesArt = reacciones.filter(r => r.articulo_id == articuloSeleccionado);
                datosInteresante = [reaccionesArt.filter(r => r.tipo_reaccion === 'üí°').length, 0, 0];
                datosDebatible = [0, reaccionesArt.filter(r => r.tipo_reaccion === '‚öñÔ∏è').length, 0];
                datosDuda = [0, 0, reaccionesArt.filter(r => r.tipo_reaccion === '‚ùì').length];
            }
            
            // Destruir gr√°fico anterior si existe
            if (chartImpacto) chartImpacto.destroy();
            
            chartImpacto = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'üí° Interesante',
                            data: datosInteresante,
                            backgroundColor: 'rgba(88, 166, 255, 0.7)',
                            borderColor: 'rgb(88, 166, 255)',
                            borderWidth: 1
                        },
                        {
                            label: '‚öñÔ∏è Debatible',
                            data: datosDebatible,
                            backgroundColor: 'rgba(240, 136, 62, 0.7)',
                            borderColor: 'rgb(240, 136, 62)',
                            borderWidth: 1
                        },
                        {
                            label: '‚ùì Duda',
                            data: datosDuda,
                            backgroundColor: 'rgba(201, 209, 217, 0.7)',
                            borderColor: 'rgb(201, 209, 217)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: articuloSeleccionado === 'all' 
                                ? 'TOP 10 ART√çCULOS POR IMPACTO' 
                                : 'DISTRIBUCI√ìN DE REACCIONES',
                            color: '#c9d1d9',
                            font: { size: 16 }
                        },
                        legend: {
                            labels: { color: '#c9d1d9' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#8b949e' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { 
                                color: '#8b949e',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        function renderizarGraficoDebatible() {
            const ctx = document.getElementById('DebatibleChart').getContext('2d');
            
            // Filtrar reacciones seg√∫n selecci√≥n
            let reaccionesFiltradas = reacciones;
            if (articuloSeleccionado !== 'all') {
                reaccionesFiltradas = reacciones.filter(r => r.articulo_id == articuloSeleccionado);
            }
            
            const Interesante = reaccionesFiltradas.filter(r => r.tipo_reaccion === 'üí°').length;
            const Debatible = reaccionesFiltradas.filter(r => r.tipo_reaccion === '‚öñÔ∏è').length;
            const Duda = reaccionesFiltradas.filter(r => r.tipo_reaccion === '‚ùì').length;
            
            // Actualizar detalles de reacciones
            document.getElementById('reactionDetails').innerHTML = `
                <div style="margin-top: 20px;">
                    <span class="reaction-badge badge-Interesante">üí° Interesante: ${Interesante}</span>
                    <span class="reaction-badge badge-Debatible">‚öñÔ∏è Debatible: ${Debatible}</span>
                    <span class="reaction-badge badge-Duda">‚ùì Duda: ${Duda}</span>
                </div>
            `;
            
            // Destruir gr√°fico anterior si existe
            if (chartDebatible) chartDebatible.destroy();
            
            chartDebatible = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Interesante', 'Debatible', 'Duda'],
                    datasets: [{
                        data: [Interesante, Debatible, Duda],
                        backgroundColor: [
                            'rgba(88, 166, 255, 0.8)',
                            'rgba(240, 136, 62, 0.8)',
                            'rgba(201, 209, 217, 0.8)'
                        ],
                        borderColor: [
                            'rgb(88, 166, 255)',
                            'rgb(240, 136, 62)',
                            'rgb(201, 209, 217)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#c9d1d9', font: { size: 14 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((context.raw / total) * 100);
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderizarHallazgosCriticos() {
            const container = document.getElementById('criticalFindings');
            
            if (articuloSeleccionado === 'all') {
                // Hallazgos globales: art√≠culos con mayor disenso
                const articulosConDisenso = articulos.map(art => {
                    const reaccionesArt = reacciones.filter(r => r.articulo_id === art.id);
                    const Debatible = reaccionesArt.filter(r => r.tipo_reaccion === '‚öñÔ∏è').length;
                    const Duda = reaccionesArt.filter(r => r.tipo_reaccion === '‚ùì').length;
                    const disenso = Debatible + Duda;
                    
                    return {
                        titulo: art.titulo,
                        autor: art.autor,
                        disenso: disenso,
                        prioridad: disenso > 10 ? 'ALTA - DISENSO' : disenso > 5 ? 'MEDIA' : 'BAJA'
                    };
                }).filter(a => a.disenso > 0).sort((a, b) => b.disenso - a.disenso);
                
                let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
                html += '<tr style="background: rgba(240,136,62,0.2);">';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 1px solid #30363d;">Art√≠culo</th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 1px solid #30363d;">Autor</th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 1px solid #30363d;">Disenso</th>';
                html += '<th style="padding: 10px; text-align: left; border-bottom: 1px solid #30363d;">Prioridad</th>';
                html += '</tr>';
                
                articulosConDisenso.forEach(art => {
                    const clasePrioridad = art.prioridad.includes('ALTA') ? 'priority-high' : 
                                          art.prioridad.includes('MEDIA') ? 'priority-medium' : 'priority-low';
                    
                    html += `<tr>
                        <td style="padding: 10px; border-bottom: 1px solid #30363d;">${art.titulo.substring(0, 40)}...</td>
                        <td style="padding: 10px; border-bottom: 1px solid #30363d;">${art.autor}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #30363d;">${art.disenso}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #30363d;" class="${clasePrioridad}">${art.prioridad}</td>
                    </tr>`;
                });
                
                html += '</table>';
                container.innerHTML = html;
                
                // Actualizar nudos cr√≠ticos
                const intervencionesDebatible = intervenciones.filter(i => 
                    i.contenido && (i.contenido.includes('Debatible') || i.contenido.includes('disenso') || 
                    i.contenido.includes('controversia') || i.contenido.includes('Duda'))
                );
                
                if (intervencionesDebatible.length > 0) {
                    const nudos = intervencionesDebatible.slice(0, 3).map(i => 
                        `"${i.contenido.substring(0, 100)}..."`
                    ).join('<br><br>');
                    
                    document.getElementById('nudosCriticos').innerHTML = nudos;
                }
                
            } else {
                // Hallazgos para art√≠culo espec√≠fico
                const art = articulos.find(a => a.id == articuloSeleccionado);
                const reaccionesArt = reacciones.filter(r => r.articulo_id == articuloSeleccionado);
                
                const Interesante = reaccionesArt.filter(r => r.tipo_reaccion === 'üí°').length;
                const Debatible = reaccionesArt.filter(r => r.tipo_reaccion === '‚öñÔ∏è').length;
                const Duda = reaccionesArt.filter(r => r.tipo_reaccion === '‚ùì').length;
                
                let prioridad = 'BAJA';
                if (Debatible + Duda > 10) prioridad = 'ALTA - DISENSO';
                else if (Debatible + Duda > 5) prioridad = 'MEDIA';
                
                container.innerHTML = `
                    <div style="margin-top: 15px;">
                        <h4>${art.titulo}</h4>
                        <p><strong>Autor:</strong> ${art.autor}</p>
                        <p><strong>Interesante:</strong> ${Interesante} | <strong>Debatible:</strong> ${Debatible} | <strong>Duda:</strong> ${Duda}</p>
                        <p class="${prioridad.includes('ALTA') ? 'priority-high' : 'priority-medium'}">
                            <strong>Prioridad para el simposio:</strong> ${prioridad}
                        </p>
                    </div>
                `;
            }
        }
        
        function renderizarIntervenciones() {
            const container = document.getElementById('interventionList');
            
            // Filtrar intervenciones seg√∫n selecci√≥n
            let intervencionesFiltradas = intervenciones;
            if (articuloSeleccionado !== 'all') {
                intervencionesFiltradas = intervenciones.filter(i => i.articulo_id == articuloSeleccionado);
            }
            
            if (intervencionesFiltradas.length === 0) {
                container.innerHTML = '<div class="alert-box">No hay intervenciones registradas para esta selecci√≥n.</div>';
                return;
            }
            
            let html = '';
            intervencionesFiltradas.forEach(intervencion => {
                const fecha = new Date(intervencion.fecha || Date.now()).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                html += `
                    <div class="intervention-item">
                        <div class="intervention-author">
                            üìù ${intervencion.usuario_nombre || 'An√≥nimo'} 
                            <span style="color: var(--blue); font-size: 0.9em;">
                                (${intervencion.usuario_email || 'Sin email'})
                            </span>
                        </div>
                        <div class="intervention-text">
                            ${intervencion.contenido || intervencion.comentario_texto || 'Sin contenido'}
                        </div>
                        <div class="intervention-meta">
                            <span>üìö ${intervencion.articulo_titulo || 'Art√≠culo no especificado'}</span>
                            <span>üìÖ ${fecha}</span>
                            <span>üì§ ${intervencion.canal_usado || 'N/A'}</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function renderizarTemasEmergentes() {
            const container = document.getElementById('emergingTopics');
            
            if (temasEmergentes.length > 0) {
                // Usar temas de la base de datos
                let html = '';
                temasEmergentes.forEach(tema => {
                    const articulosRel = tema.articulos_relacionados || [];
                    const articulosText = articulosRel.length > 0 
                        ? `Relacionado con ${articulosRel.length} art√≠culo(s)` 
                        : 'Sin art√≠culos relacionados';
                    
                    html += `
                        <div class="topic-bubble" onclick="detalleTema(${tema.id})">
                            <div class="topic-title">${tema.tema}</div>
                            <div class="topic-stats">
                                <span>üìä ${tema.intervenciones_count || 0} intervenciones</span>
                                <span class="${tema.estado === 'confirmado' ? 'priority-high' : 'priority-medium'}">
                                    ${tema.estado || 'emergente'}
                                </span>
                            </div>
                            <div style="font-size: 0.9em; color: #8b949e; margin-top: 5px;">
                                ${articulosText}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } else {
                // Generar temas emergentes autom√°ticamente a partir de intervenciones
                const temasDetectados = detectarTemasEmergentes();
                
                if (temasDetectados.length === 0) {
                    container.innerHTML = '<div class="alert-box">Analizando intervenciones para detectar temas emergentes...</div>';
                    return;
                }
                
                let html = '<p><strong>Temas detectados autom√°ticamente:</strong></p>';
                temasDetectados.forEach((tema, index) => {
                    html += `
                        <div class="topic-bubble">
                            <div class="topic-title">${tema.nombre}</div>
                            <div class="topic-stats">
                                <span>üìä ${tema.frecuencia} menciones</span>
                                <span class="priority-medium">emergente</span>
                            </div>
                            <div style="font-size: 0.9em; color: #8b949e; margin-top: 5px;">
                                ${tema.ejemplo ? `Ej: "${tema.ejemplo.substring(0, 80)}..."` : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }
        
        function detectarTemasEmergentes() {
            // Palabras clave para detectar temas
            const keywords = [
                { palabra: 'inteligencia artificial', tema: 'IA en estrategia militar' },
                { palabra: 'seguridad ciudadana', tema: 'Estrategias de seguridad' },
                { palabra: 'geopol√≠tica', tema: 'Geopol√≠tica del pensamiento' },
                { palabra: 'disenso', tema: 'Nudos cr√≠ticos de disenso' },
                { palabra: 'estrategia', tema: 'Estrategias asim√©tricas' },
                { palabra: 'manipulaci√≥n', tema: 'Manipulaci√≥n y poder' },
                { palabra: 'redes', tema: 'Redes de poder' },
                { palabra: 'tecnolog√≠a', tema: 'Tecnolog√≠a y conflicto' },
                { palabra: 'juventud', tema: 'Juventud y gerontocracia' },
                { palabra: 'tiempo social', tema: 'Explotaci√≥n del tiempo' }
            ];
            
            const temas = {};
            
            // Analizar intervenciones
            intervenciones.forEach(intervencion => {
                const texto = (intervencion.contenido || intervencion.comentario_texto || '').toLowerCase();
                
                keywords.forEach(keyword => {
                    if (texto.includes(keyword.palabra)) {
                        if (!temas[keyword.tema]) {
                            temas[keyword.tema] = {
                                nombre: keyword.tema,
                                frecuencia: 0,
                                ejemplo: texto.substring(0, 100)
                            };
                        }
                        temas[keyword.tema].frecuencia++;
                    }
                });
            });
            
            // Convertir a array y ordenar por frecuencia
            return Object.values(temas)
                .sort((a, b) => b.frecuencia - a.frecuencia)
                .slice(0, 5); // Top 5 temas
        }
        
        function detalleTema(temaId) {
            // Implementar vista detallada del tema
            alert(`Detalle del tema ID: ${temaId} - Esta funci√≥n se implementar√° en la siguiente fase.`);
        }
        
        async function generarReportePDF() {
            try {
                // Recopilar datos para el reporte
                const datosReporte = {
                    fecha: new Date().toISOString(),
                    articulosAnalizados: articulos.length,
                    totalReacciones: reacciones.length,
                    totalIntervenciones: intervenciones.length,
                    temasEmergentes: temasEmergentes.length > 0 ? temasEmergentes : detectarTemasEmergentes(),
                    hallazgosCriticos: obtenerHallazgosParaPDF()
                };
                
                // Mostrar mensaje de generaci√≥n
                alert(`üìÑ Reporte estrat√©gico generado con √©xito!\n\nSe han procesado:\n‚Ä¢ ${datosReporte.articulosAnalizados} art√≠culos\n‚Ä¢ ${datosReporte.totalReacciones} reacciones\n‚Ä¢ ${datosReporte.totalIntervenciones} intervenciones\n\nLos temas emergentes han sido identificados para el Simposio 2025.`);
                
                // Aqu√≠ ir√≠a la l√≥gica para generar el PDF real
                // Podr√≠amos usar jsPDF o enviar a un backend
                console.log('Datos para PDF:', datosReporte);
                
                // Guardar en Supabase el reporte generado
                await _supabase.from('reportes_simposio').insert([{
                    tipo: 'reporte_estrategico',
                    datos: datosReporte,
                    fecha_generacion: new Date().toISOString()
                }]);
                
            } catch (error) {
                console.error('Error generando reporte:', error);
                alert('Error al generar el reporte: ' + error.message);
            }
        }
        
        function obtenerHallazgosParaPDF() {
            return articulos.map(art => {
                const reaccionesArt = reacciones.filter(r => r.articulo_id === art.id);
                return {
                    titulo: art.titulo,
                    autor: art.autor,
                    Interesante: reaccionesArt.filter(r => r.tipo_reaccion === 'üí°').length,
                    Debatible: reaccionesArt.filter(r => r.tipo_reaccion === '‚öñÔ∏è').length,
                    Duda: reaccionesArt.filter(r => r.tipo_reaccion === '‚ùì').length,
                    tesis: reaccionesArt.filter(r => r.tipo_reaccion.includes('üí¨')).length
                };
            }).sort((a, b) => (b.Debatible + b.Duda) - (a.Debatible + a.Duda));
        }
        
        // ==================== FUNCIONES ADICIONALES ====================
        // Funci√≥n para actualizar datos en tiempo real (opcional)
        async function actualizarDatosEnVivo() {
            console.log('üîÑ Actualizando datos en vivo...');
            await cargarTodosLosDatos();
            renderizarDashboard();
        }
        
        // Configurar actualizaci√≥n autom√°tica cada 2 minutos
        setInterval(actualizarDatosEnVivo, 120000);
    </script>
</body>
</html>
