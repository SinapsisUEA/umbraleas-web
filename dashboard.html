<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√∫nker de Inteligencia - SINAPSIS</title>
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg: #0a0c10;
            --card: #161b22;
            --blue: #58a6ff;
            --orange: #f0883e;
            --red: #ff4444;
            --green: #2ea043;
            --silver: #c9d1d9;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--silver);
            margin: 0;
            padding: 20px;
        }
        
        .bunker-header {
            background: linear-gradient(135deg, #000 0%, #1a1f29 100%);
            border-bottom: 3px solid var(--orange);
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .bunker-header h1 {
            color: var(--orange);
            font-size: 2.5em;
            margin: 0;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .bunker-header h2 {
            color: var(--blue);
            font-size: 1.2em;
            margin: 10px 0 0;
            font-weight: 300;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .dashboard-card {
            background: var(--card);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #30363d;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            border-color: var(--blue);
        }
        
        .card-title {
            color: var(--orange);
            border-bottom: 2px solid;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .card-full-width {
            grid-column: 1 / -1;
        }
        
        .card-tall {
            grid-row: span 2;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #30363d;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--blue);
            margin: 10px 0;
        }
        
        .stat-label {
            color: var(--silver);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .reaction-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            margin: 2px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        /* CLASES CORREGIDAS */
        .badge-Interesante { background: rgba(88, 166, 255, 0.2); color: var(--blue); border: 1px solid var(--blue); }
        .badge-Debatible { background: rgba(240, 136, 62, 0.2); color: var(--orange); border: 1px solid var(--orange); }
        .badge-Duda { background: rgba(201, 209, 217, 0.2); color: var(--silver); border: 1px solid var(--silver); }
        
        .article-selector {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #30363d;
            color: white;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 1em;
        }
        
        .intervention-list {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .intervention-item {
            background: rgba(255,255,255,0.03);
            border-left: 4px solid var(--blue);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s;
        }
        
        .intervention-item:hover {
            background: rgba(255,255,255,0.07);
            border-left-color: var(--orange);
        }
        
        .intervention-author {
            color: var(--orange);
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .intervention-text {
            margin: 10px 0;
            line-height: 1.5;
            color: #e6edf3;
        }
        
        .intervention-meta {
            font-size: 0.85em;
            color: #8b949e;
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .priority-high { color: var(--red); font-weight: bold; }
        .priority-medium { color: var(--orange); }
        .priority-low { color: var(--silver); }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .topic-bubble {
            background: linear-gradient(135deg, rgba(88,166,255,0.1) 0%, rgba(240,136,62,0.1) 100%);
            border: 1px solid var(--blue);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .topic-bubble:hover {
            background: linear-gradient(135deg, rgba(88,166,255,0.2) 0%, rgba(240,136,62,0.2) 100%);
            transform: scale(1.02);
        }
        
        .topic-title {
            color: var(--blue);
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .topic-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: var(--silver);
        }
        
        .btn-generate-pdf {
            background: var(--orange);
            color: black;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            font-size: 1.1em;
            transition: background 0.3s;
        }
        
        .btn-generate-pdf:hover {
            background: #ff9c55;
        }
        
        .alert-box {
            background: rgba(240, 136, 62, 0.1);
            border: 1px solid var(--orange);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            color: var(--orange);
        }
        
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bunker-header">
        <h1>üõ°Ô∏è B√öNKER DE INTELIGENCIA</h1>
        <h2>SIMPOSIO SINAPSIS 2025 - GEOPOL√çTICA DEL PENSAMIENTO CR√çTICO</h2>
        <p>Unidad de Inteligencia de Datos - Reporte de Disenso</p>
    </div>
    
    <div class="dashboard-grid">
        <!-- Tarjeta 1: Impacto General -->
        <div class="dashboard-card card-tall">
            <h3 class="card-title">üìä IMPACTO POR ART√çCULO</h3>
            
            <select class="article-selector" id="articleSelector" onchange="cargarDatosArticulo()">
                <option value="all">üìà TODOS LOS ART√çCULOS (Vista Consolidada)</option>
                <!-- Los art√≠culos se cargar√°n din√°micamente -->
            </select>
            
            <div class="chart-container">
                <canvas id="impactChart"></canvas>
            </div>
            
            <div class="stats-grid" id="globalStats">
                <!-- Estad√≠sticas globales se cargar√°n aqu√≠ -->
            </div>
        </div>
        
        <!-- Tarjeta 2: Naturaleza de las Reacciones -->
        <div class="dashboard-card">
            <h3 class="card-title">üéØ NATURALEZA DE LAS REACCIONES</h3>
            
            <div class="chart-container">
                <canvas id="DebatibleChart"></canvas>
            </div>
            
            <div id="reactionDetails">
                <!-- Detalles de reacciones por tipo -->
            </div>
        </div>
        
        <!-- Tarjeta 3: Hallazgos Cr√≠ticos -->
        <div class="dashboard-card">
            <h3 class="card-title">‚ö†Ô∏è HALLAZGOS CR√çTICOS</h3>
            
            <div id="criticalFindings">
                <!-- Hallazgos cr√≠ticos se cargar√°n aqu√≠ -->
            </div>
            
            <div class="alert-box">
                <strong>üéØ NUDOS CR√çTICOS (DISENSO)</strong>
                <p id="nudosCriticos">Cargando an√°lisis de disenso...</p>
            </div>
        </div>
        
        <!-- Tarjeta 4: Intervenciones de Lectores -->
        <div class="dashboard-card card-full-width">
            <h3 class="card-title">üì® BUZ√ìN DE INTERACCI√ìN</h3>
            <p>Di√°logos cr√≠ticos con autores - Base para temas del simposio</p>
            
            <div class="intervention-list" id="interventionList">
                <!-- Las intervenciones se cargar√°n aqu√≠ -->
            </div>
        </div>
        
        <!-- Tarjeta 5: Temas Emergentes para el Simposio -->
        <div class="dashboard-card card-full-width">
            <h3 class="card-title">üéôÔ∏è TEMAS EMERGENTES - SIMPOSIO 2025</h3>
            <p>Temas detectados a partir de las intervenciones de lectores</p>
            
            <div id="emergingTopics">
                <!-- Temas emergentes se cargar√°n aqu√≠ -->
            </div>
            
            <button class="btn-generate-pdf" onclick="generarReportePDF()">
                üìÑ GENERAR REPORTE ESTRAT√âGICO (PDF)
            </button>
        </div>
    </div>
    
    <script>
        // ==================== CONFIGURACI√ìN SUPABASE ====================
        const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        
        // Variables globales
        let articulos = [];
        let reacciones = [];
        let intervenciones = [];
        let temasEmergentes = [];
        let chartImpacto = null;
        let chartDebatible = null;
        let articuloSeleccionado = 'all';
        
        // ==================== INICIALIZACI√ìN ====================
        window.onload = async () => {
            console.log('üõ°Ô∏è Iniciando B√∫nker de Inteligencia...');
            await cargarTodosLosDatos();
            inicializarSelectArticulos();
            renderizarDashboard();
        };
        
        // ==================== FUNCIONES DE CARGA DE DATOS ====================
        async function cargarTodosLosDatos() {
            try {
                // 1. Cargar art√≠culos
                const { data: articulosData, error: errorArticulos } = await _supabase
                    .from('articulos')
                    .select('*')
                    .order('id', { ascending: false });
                
                if (errorArticulos) throw errorArticulos;
                articulos = articulosData || [];
                console.log(`‚úÖ ${articulos.length} art√≠culos cargados`);
                
                // 2. Cargar reacciones
                const { data: reaccionesData, error: errorReacciones } = await _supabase
                    .from('sinapsis_reacciones')
                    .select('*');
                
                if (errorReacciones) throw errorReacciones;
                reacciones = reaccionesData || [];
                console.log(`‚úÖ ${reacciones.length} reacciones cargadas`);
                
                // 3. Cargar intervenciones (dashboard_intervenciones)
                const { data: intervencionesData, error: errorIntervenciones } = await _supabase
                    .from('dashboard_intervenciones')
                    .select('*')
                    .order('fecha', { ascending: false });
                
                if (errorIntervenciones) {
                    console.warn('‚ö†Ô∏è No se encontr√≥ tabla dashboard_intervenciones, usando sinapsis_reacciones');
                    // Si no existe la tabla
