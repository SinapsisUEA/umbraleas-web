<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sinapsis | B√∫nker de Inteligencia</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --bg: #05070a; --panel: #0d1117; --blue: #58a6ff; --orange: #f0883e; --silver: #c9d1d9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--silver); margin: 0; padding: 20px; }
        header { border-bottom: 2px solid var(--blue); padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .stat-card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid #30363d; }
        .stat-card h2 { color: var(--blue); font-size: 1.2em; border-bottom: 1px solid #333; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85em; }
        th { border-bottom: 2px solid var(--blue); color: var(--orange); padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #30363d; }
        .msg-box { background: rgba(88, 166, 255, 0.05); border-left: 4px solid var(--blue); padding: 10px; margin-bottom: 10px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="header-pdf" style="display: none; border-bottom: 3px double var(--orange); padding: 20px; background: #000;">
    <h1 style="color: var(--orange); margin: 0;">SIMPOSIO SINAPSIS 2026</h1>
    <p style="color: #fff;">REPORTE DE INTELIGENCIA Y DI√ÅLOGOS CR√çTICOS</p>
</div>

<header>
    <h1><i class="fas fa-shield-halved"></i> B√öNKER DE INTELIGENCIA</h1>
    <div>
        <button onclick="cargarTodo()" style="background:var(--blue); border:none; padding:10px 15px; cursor:pointer; font-weight:bold; color:#000;">RECARGAR SENSOR</button>
        <button onclick="exportarPDF()" style="background:var(--orange); border:none; padding:10px 15px; margin-left:10px; cursor:pointer; font-weight:bold; color:#000;">GENERAR REPORTE PDF</button>
    </div>
</header>

<div class="grid-stats">
    <div class="stat-card">
        <h2><i class="fas fa-users"></i> REGISTRO DE ACTORES (SIMPOSIO)</h2>
        <div id="lista-inscritos" style="max-height: 400px; overflow-y: auto;">Cargando agentes...</div>
    </div>

    <div class="stat-card">
        <h2><i class="fas fa-comments"></i> INTERVENCIONES Y TESIS RECIBIDAS</h2>
        <div id="lista-mensajes" style="max-height: 400px; overflow-y: auto;">Escaneando di√°logos cr√≠ticos...</div>
    </div>
</div>

<div class="stat-card" style="margin-top:20px;">
    <h2>AN√ÅLISIS DE IMPACTO Y DISENSO</h2>
    <table>
        <thead>
            <tr>
                <th>ART√çCULO</th>
                <th>AUTOR</th>
                <th>üí°</th>
                <th>‚öñÔ∏è</th>
                <th>‚ùì</th>
                <th>ESTADO</th>
            </tr>
        </thead>
        <tbody id="tabla-impacto"></tbody>
    </table>
</div>

<script>
    const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    async function cargarTodo() {
        // 1. Cargar Inscritos
        const { data: inscritos } = await _supabase.from('sinapsis_registros').select('*').order('created_at', { ascending: false });
        document.getElementById('lista-inscritos').innerHTML = inscritos?.length ? inscritos.map(ins => `
            <div style="border-bottom:1px solid #333; padding:10px; margin-bottom:5px;">
                <strong style="color:var(--orange)">${ins.nombre}</strong><br>
                <small>${ins.institucion || 'Independiente'}</small> | <small style="color:var(--blue)">${ins.email}</small>
            </div>
        `).join('') : "No hay actores registrados.";

        // 2. Cargar Di√°logos y Reacciones (Unificando con T√≠tulos)
        const { data: reacciones } = await _supabase.from('sinapsis_reacciones').select('*, articulos(titulo, autor)').order('created_at', { ascending: false });
        
        // Filtrar solo mensajes (üí¨)
        const mensajes = reacciones?.filter(r => r.tipo_reaccion === 'üí¨') || [];
        document.getElementById('lista-mensajes').innerHTML = mensajes.length ? mensajes.map(m => `
            <div class="msg-box">
                <small style="color:var(--orange)">REF: ${m.articulos?.titulo || 'General'}</small><br>
                <p style="margin:5px 0; font-style:italic;">"${m.comentario_texto}"</p>
                <small style="color:gray;">Enviado el: ${new Date(m.created_at).toLocaleDateString()}</small>
            </div>
        `).join('') : "Esperando tesis de los lectores...";

        // 3. Procesar Tabla de Impacto
        procesarImpacto(reacciones);
    }

    function procesarImpacto(data) {
        const stats = {};
        data?.forEach(r => {
            const tit = r.articulos?.titulo || "Desconocido";
            if (!stats[tit]) stats[tit] = { autor: r.articulos?.autor, l:0, d:0, q:0 };
            if (r.tipo_reaccion === 'üí°') stats[tit].l++;
            if (r.tipo_reaccion === '‚öñÔ∏è') stats[tit].d++;
            if (r.tipo_reaccion === '‚ùì') stats[tit].q++;
        });

        document.getElementById('tabla-impacto').innerHTML = Object.keys(stats).map(t => {
            const s = stats[t];
            const disenso = s.d + s.q > 2;
            return `<tr>
                <td>${t}</td>
                <td style="color:var(--blue)">${s.autor}</td>
                <td>${s.l}</td><td>${s.d}</td><td>${s.q}</td>
                <td style="color:${disenso ? 'var(--orange)' : 'gray'}">${disenso ? 'üî• ALTO DISENSO' : 'Estable'}</td>
            </tr>`;
        }).join('');
    }

    function exportarPDF() {
        const head = document.getElementById('header-pdf');
        head.style.display = 'block';
        const opt = { margin: 10, filename: 'SINAPSIS_BUNKER_2026.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, backgroundColor: '#05070a' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
        html2pdf().set(opt).from(document.body).save().then(() => head.style.display = 'none');
    }

    window.onload = cargarTodo;
</script>
</body>
</html>
