<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINAPSIS | Revista de Estrategia y Seguridad</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg: #05070a; --panel: #0d1117; --accent: #58a6ff; --alert: #f0883e; 
            --text-main: #c9d1d9; --text-muted: #8b949e; --font-serif: 'Libre Baskerville', serif;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; }
        
        header { background: #000; padding: 40px 20px; text-align: center; border-bottom: 2px solid #30363d; }
        .brand-logo { font-family: var(--font-serif); font-size: 3em; letter-spacing: 6px; color: var(--accent); margin: 0; }

        /* Bot√≥n con Protocolo de Acceso */
        .admin-access {
            display: inline-block; margin-top: 20px; padding: 10px 20px;
            border: 1px solid #333; color: #555; text-decoration: none; font-size: 0.8em;
            transition: 0.3s; cursor: pointer;
        }
        .admin-access:hover { color: var(--accent); border-color: var(--accent); }

        /* Contenedor Principal: Art√≠culos Primero */
        .main-layout { max-width: 1400px; margin: auto; padding: 40px; }
        .article-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; margin-bottom: 60px; }

        .card {
            background: var(--panel); border: 1px solid #30363d; height: 450px;
            position: relative; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; justify-content: flex-end;
        }
        .card-image { position: absolute; top:0; left:0; width:100%; height:100%; background-size:cover !important; z-index:1; opacity: 0.6; transition: 0.5s; }
        .card:hover .card-image { opacity: 0.8; transform: scale(1.05); }
        .card-content { position: relative; z-index: 2; padding: 25px; background: linear-gradient(to top, #05070a, transparent); }

        /* Estaci√≥n Multimedia (Ahora abajo) */
        .multimedia-footer {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px;
            background: var(--panel); border-top: 1px solid var(--accent); padding: 40px;
        }

        /* --- MODAL DE LECTURA CIENT√çFICA CON GLOSA LATERAL --- */
.modal { 
    display: none; 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    background: rgba(0,0,0,0.98); 
    z-index: 1000; 
}

.modal-content { 
    background: var(--bg); 
    width: 90%; 
    max-width: 1100px; /* Un poco m√°s ancho para la columna lateral */
    margin: 20px auto; 
    padding: 50px; 
    height: 90vh; 
    overflow-y: auto; 
    border: 1px solid #30363d;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
}

.citation-box { 
    background: #161b22; 
    padding: 20px; 
    border-left: 4px solid var(--accent); 
    margin: 30px 0; 
    font-size: 0.9em; 
    color: var(--text-muted);
}

/* Estructura de P√°rrafo + Reacciones al margen */
.bloque-lectura {
    display: grid;
    grid-template-columns: 1fr 100px; /* El texto ocupa el 1fr, las reacciones 100px */
    gap: 40px;
    margin-bottom: 30px;
    align-items: start;
}

.texto-parrafo {
    line-height: 1.9;
    font-size: 1.15em;
    color: #d1d5db;
    text-align: justify;
}

.columna-reacciones {
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: sticky;
    top: 20px;
}

.btn-glosa {
    background: #111;
    border: 1px solid #333;
    color: #888;
    padding: 10px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.9em;
    transition: 0.3s;
}

.btn-glosa:hover {
    border-color: var(--accent);
    color: #fff;
    background: rgba(88, 166, 255, 0.1);
}
    </style>
</head>
<body>

<header>
    <h1 class="brand-logo">SINAPSIS</h1>
    <p style="color:var(--alert); font-size: 0.9em; letter-spacing: 2px;">REVISTA CIENT√çFICA DE ESTRATEGIA ASIM√âTRICA</p>
    <div class="admin-access" onclick="accesoBunker()">
        <i class="fas fa-lock"></i> ACCESO RESERVADO ADMINISTRACI√ìN
    </div>
</header>

<div class="main-layout">
    <h2 style="font-family: var(--font-serif); border-bottom: 1px solid #333; padding-bottom: 10px;">ART√çCULOS ORIGINALES</h2>
    <div class="article-grid" id="grid-articulos">
        </div>
</div>

<section class="multimedia-footer">
    <div style="aspect-ratio: 16/9; background: #000;">
        <iframe id="mainVideo" width="100%" height="100%" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
    </div>
    <div style="padding: 20px;">
        <h3 style="color:var(--accent); font-family: var(--font-serif);">RECURSOS AUDIOVISUALES</h3>
        <p style="font-size: 0.85em; color: var(--text-muted);">Complementos de investigaci√≥n y entrevistas semanales.</p>
        <audio id="mainPodcast" controls style="width:100%; margin-top: 20px;"></audio>
    </div>
</section>

<div id="modalArticulo" class="modal">
    <div class="modal-content">
        <span onclick="cerrarLectura()" style="float:right; color:var(--alert); cursor:pointer;"><i class="fas fa-times fa-2x"></i></span>
        <div id="contenidoArticulo"></div>
    </div>
</div>

<script>
    const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    // Protocolo de seguridad para el B√∫nker
    function accesoBunker() {
        const pass = prompt("Acceso restringido. Ingrese clave de comando:");
        if (pass === "admin123") { // Puedes cambiar esta clave
            window.location.href = "dashboard.html";
        } else {
            alert("Acceso Denegado. Se ha registrado el intento de entrada.");
        }
    }

    async function obtenerArticulos() {
        const { data, error } = await _supabase.from('articulos').select('*').order('id', { ascending: false });
        if (data) dibujarCards(data);
    }

    function dibujarCards(lista) {
        const grid = document.getElementById('grid-articulos');
        grid.innerHTML = lista.map(art => `
            <div class="card" onclick='abrirLectura(${JSON.stringify(art).replace(/'/g, "&apos;")})'>
                <div class="card-image" style="background: url('${art.Imagen_URL}') center/cover;"></div>
                <div class="card-content">
                    <small style="color:var(--accent); font-weight:bold;">${art.Categoria || 'SEGURIDAD'}</small>
                    <h3 style="margin: 10px 0; font-family: var(--font-serif);">${art.Titulo}</h3>
                    <p style="font-size: 0.8em; color: var(--text-muted);">${art.Autor}</p>
                </div>
            </div>
        `).join('');
    }

    function abrirLectura(art) {
    const modal = document.getElementById('modalArticulo');
    const contenido = document.getElementById('contenidoArticulo');
    
    // Generaci√≥n de DOI ficticio basado en el ID si no existe
    const doi = art.DOI || "10.555/sinapsis.2025." + art.id;

    const encabezado = `
        <div style="border-bottom: 1px solid #30363d; margin-bottom: 40px; padding-bottom: 20px;">
            <small style="color:var(--accent); letter-spacing:2px;">REVISTA SINAPSIS | VOL. I | 2025</small>
            <h1 style="font-family: var(--font-serif); font-size: 2.8em; margin: 15px 0; line-height: 1.1; color: #fff;">${art.Titulo}</h1>
            <p style="font-size: 1.1em;"><strong>Investigador:</strong> ${art.Autor} | <strong>DOI:</strong> <span style="color:var(--accent)">${doi}</span></p>
            <div class="citation-box">
                <strong>Referencia Bibliogr√°fica (APA):</strong><br>
                ${art.Autor.split(' ').pop()}, ${art.Autor[0]}. (2025). ${art.Titulo}. <i>Sinapsis: Estrategia y Seguridad</i>.
            </div>
        </div>
    `;

    // Procesamiento de cada p√°rrafo con su columna de iconos a la derecha
    let htmlCuerpo = art.Contenido.split('\n').map((p, i) => {
        if(p.trim() === "") return "";
        return `
            <div class="bloque-lectura">
                <div class="texto-parrafo">${p}</div>
                <div class="columna-reacciones">
                    <button class="btn-glosa" title="Inter√©s" onclick="reaccionar(${art.id}, ${i}, 'üí°')">üí°</button>
                    <button class="btn-glosa" title="Debate" onclick="reaccionar(${art.id}, ${i}, '‚öñÔ∏è')">‚öñÔ∏è</button>
                    <button class="btn-glosa" title="Duda" onclick="reaccionar(${art.id}, ${i}, '‚ùì')">‚ùì</button>
                </div>
            </div>
        `;
    }).join('');

    const buzon = `
        <div style="margin-top:60px; padding:40px; background:var(--panel); border: 1px solid var(--accent); border-radius:4px;">
            <h3 style="color:var(--accent); font-family:var(--font-serif); margin-top:0;">Solicitud de Di√°logo Acad√©mico</h3>
            <textarea id="comentarioAutor" placeholder="Escriba su consulta t√©cnica para el autor..." 
                      style="width:100%; height:120px; background:#000; color:#fff; border:1px solid #333; padding:15px; margin-top:15px; font-family:inherit;"></textarea>
            <button onclick="enviarMensajeFinal(${art.id}, '${art.Autor.replace(/'/g, "\\'")}', '${art.Titulo.replace(/'/g, "\\'")}')" 
                    style="margin-top:20px; background:var(--accent); border:none; padding:12px 30px; font-weight:bold; cursor:pointer; color:#000; text-transform:uppercase; letter-spacing:1px;">
                Transmitir al Investigador
            </button>
        </div>
    `;

    contenido.innerHTML = encabezado + htmlCuerpo + buzon;
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

    async function enviarMensajeFinal(artId, autor, titulo) {
        const texto = document.getElementById('comentarioAutor').value.trim();
        if(!texto) return;

        // REGISTRO LIMPIO EN SUPABASE
        const { error } = await _supabase.from('sinapsis_reacciones').insert([{
            art√≠culo_id: artId,
            tipo_reaccion: 'üí¨',
            comentario_texto: texto,
            parrafo_index: 0
        }]);

        if (!error) {
            // MAILTO BLINDADO PARA CARACTERES ESPECIALES
            const subject = encodeURIComponent(`Consulta Sinapsis: ${titulo}`);
            const body = encodeURIComponent(`Estimado(a) ${autor},\n\nSe ha recibido un comentario sobre su art√≠culo "${titulo}":\n\n"${texto}"`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
            alert("Mensaje registrado y canal de comunicaci√≥n abierto.");
        }
    }

    async function reaccionar(artId, pIndex, tipo) {
        await _supabase.from('sinapsis_reacciones').insert([{ art√≠culo_id: artId, parrafo_index: pIndex, tipo_reaccion: tipo }]);
        alert("Reacci√≥n integrada.");
    }

    function cerrarLectura() {
        document.getElementById('modalArticulo').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    obtenerArticulos();
</script>
</body>
</html>
