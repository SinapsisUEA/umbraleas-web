<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINAPSIS | Estrategia y Seguridad</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #05070a; --panel: #0d1117; --accent: #58a6ff; --alert: #f0883e; --text: #c9d1d9; --font-serif: 'Libre Baskerville', serif; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        
        header { background: #000; padding: 40px; text-align: center; border-bottom: 2px solid #30363d; position: relative; }
        .brand { font-family: var(--font-serif); font-size: 3em; letter-spacing: 5px; color: var(--accent); margin: 0; text-decoration: none; }
        
        /* Simposio */
        .simposium { max-width: 1100px; margin: 40px auto; padding: 40px; border: 1px solid var(--alert); display: grid; grid-template-columns: 1fr 1fr; gap: 40px; background: #000; border-radius: 4px; }
        .reg-form { display: flex; flex-direction: column; gap: 10px; }
        .reg-form input { padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 4px; }
        
        /* Grid de Art√≠culos */
        .grid { max-width: 1200px; margin: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; padding: 20px; }
        .card { background: var(--panel); border: 1px solid #333; cursor: pointer; transition: 0.3s; position: relative; height: 400px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; border-radius: 8px; }
        .card:hover { border-color: var(--accent); transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card-img { position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0.5; z-index:1; background-size: cover !important; }
        .card-body { position: relative; z-index: 2; padding: 25px; background: linear-gradient(transparent, #000 70%); }
        .auth-badge { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--accent); object-fit: cover; }

        /* Modal de Lectura */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 1000; }
        .modal-content { background: var(--bg); width: 90%; max-width: 900px; margin: 2vh auto; padding: 50px; height: 90vh; overflow-y: auto; border: 1px solid #333; position: relative; }
        .bloque { display: grid; grid-template-columns: 1fr 60px; gap: 20px; margin-bottom: 25px; align-items: start; }
        .texto { line-height: 1.8; font-size: 1.15em; text-align: justify; color: #d1d5db; }
        .btn-g { background: #111; border: 1px solid #444; color: #aaa; padding: 10px; cursor: pointer; margin-bottom: 5px; border-radius: 4px; transition: 0.2s; }
        .btn-g:hover { background: var(--accent); color: #000; }
    </style>
</head>
<body>

<header>
    <div onclick="accesoBunker()" style="position:absolute; right:20px; top:20px; color:#1a1a1a; cursor:pointer;"><i class="fas fa-terminal"></i></div>
    <a href="#" class="brand">SINAPSIS</a>
    <p style="color:var(--alert); font-weight:bold; letter-spacing:3px; margin-top:10px;">ESTRATEGIA & INTELIGENCIA</p>
</header>

<section class="simposium">
    <div>
        <h2 style="color:var(--alert); font-family:var(--font-serif); font-size: 2em; margin-top:0;">SIMPOSIO 2025</h2>
        <p>Reg√≠strese para participar en las mesas de di√°logo y recibir los reportes de inteligencia estrat√©gica.</p>
        <p style="font-size: 0.9em; color: var(--accent);"><i class="fas fa-calendar"></i> 28 de Octubre | 19:00 UTC</p>
    </div>
    <div class="reg-form" id="area-reg">
        <input type="text" id="rn" placeholder="Nombre Completo">
        <input type="email" id="re" placeholder="Correo Electr√≥nico">
        <input type="text" id="ri" placeholder="Instituci√≥n / Organismo">
        <button onclick="registrarSimposio()" style="padding:15px; background:var(--alert); border:none; font-weight:bold; cursor:pointer; color:#000; border-radius:4px; transition: 0.3s;">CONFIRMAR ASISTENCIA</button>
    </div>
</section>

<div class="grid" id="grid-articulos"></div>

<div id="modalArticulo" class="modal">
    <div class="modal-content">
        <span onclick="cerrar()" style="position: sticky; top: 0; float:right; cursor:pointer; color:var(--alert); font-weight:bold; font-size: 1.2em; z-index:10;">[ CERRAR ]</span>
        <div id="cont"></div>
    </div>
</div>

<script>
    // CONFIGURACI√ìN DE NODO CENTRAL
    const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let localArt = [];

    async function cargar() {
        const { data, error } = await _supabase.from('articulos').select('*').order('id', { ascending: false });
        if (data) { localArt = data; dibujar(data); }
    }

    function dibujar(lista) {
        document.getElementById('grid-articulos').innerHTML = lista.map((a, i) => `
            <div class="card" onclick="abrir(${i})">
                <div class="card-img" style="background:url('${a.Imagen_URL}') center/cover;"></div>
                <div class="card-body">
                    <div class="auth-badge">
                        <img src="${a.Avatar_URL || 'https://ui-avatars.com/api/?name='+a.Autor}" class="avatar">
                        <small style="color:var(--accent)">Investigador: ${a.Autor}</small>
                    </div>
                    <h3 style="margin:0; font-family:var(--font-serif); color:#fff; font-size:1.5em;">${a.Titulo}</h3>
                </div>
            </div>
        `).join('');
    }

    function abrir(i) {
        const a = localArt[i];
        const modal = document.getElementById('modalArticulo');
        const doi = a.DOI || "10.555.sinapsis.2025." + a.id;
        
        let pTotal = a.Contenido.split('\n').map((p, idx) => p.trim() ? `
            <div class="bloque">
                <div class="texto">${p}</div>
                <div style="display:flex; flex-direction:column;">
                    <button title="Aporte" class="btn-g" onclick="reaccionar(${a.id},${idx},'üí°')">üí°</button>
                    <button title="Duda" class="btn-g" onclick="reaccionar(${a.id},${idx},'‚ùì')">‚ùì</button>
                </div>
            </div>` : "").join('');

        const buzon = `
            <div style="background:var(--panel); padding:35px; border:1px solid var(--accent); margin-top:50px; border-radius:8px;">
                <h3 style="color:var(--accent); margin-top:0; font-family:var(--font-serif);">Solicitud de Di√°logo T√©cnico</h3>
                <p style="font-size:0.85em; color:#8b949e; margin-bottom:20px;">Su identidad ser√° registrada en el B√∫nker para validar el aporte cient√≠fico.</p>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <input type="text" id="m-n" placeholder="Su Nombre Completo" style="padding:12px; background:#000; border:1px solid #333; color:#fff;">
                    <input type="email" id="m-e" placeholder="Correo de Contacto" style="padding:12px; background:#000; border:1px solid #333; color:#fff;">
                </div>
                
                <textarea id="m-t" placeholder="Desarrolle su tesis, duda o propuesta..." style="width:100%; height:120px; background:#000; color:#fff; border:1px solid #333; padding:15px; font-family:inherit; resize:none;"></textarea>
                
                <div style="margin-top:15px; font-size:0.85em; color:#8b949e;">
                    <input type="checkbox" id="chk-suscripcion" checked> 
                    <label for="chk-suscripcion">Autorizo el registro de mis datos para el ecosistema Sinapsis.</label>
                </div>

                <button onclick="enviarFinal(${i})" style="width:100%; padding:18px; background:var(--alert); border:none; margin-top:20px; font-weight:bold; cursor:pointer; color:#000; letter-spacing:1px;">
                    TRANSMITIR AL B√öNKER Y AL AUTOR
                </button>
            </div>
        `;

        document.getElementById('cont').innerHTML = `
            <small style="color:var(--alert); letter-spacing:2px;">REVISTA SINAPSIS | VOL. I</small>
            <h1 style="color:var(--accent); font-family:var(--font-serif); font-size:2.8em; margin:10px 0;">${a.Titulo}</h1>
            <p style="margin-bottom:30px;"><strong>Investigador:</strong> ${a.Autor} | <strong>DOI:</strong> ${doi}</p>
            <hr style="border:0; border-top:1px solid #333; margin-bottom:40px;">
            ${pTotal}
            ${buzon}
        `;
        
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    async function enviarFinal(i) {
        const a = localArt[i];
        const n = document.getElementById('m-n').value.trim();
        const e = document.getElementById('m-e').value.trim();
        const t = document.getElementById('m-t').value.trim();
        const suscrito = document.getElementById('chk-suscripcion').checked;

        if(!n || !e || !t) return alert("Por favor, complete todos los campos de identificaci√≥n.");

        // 1. REGISTRO EN B√öNKER (Usando 'art√≠culo_id' para coincidir con Supabase)
        const { error: err1 } = await _supabase.from('sinapsis_reacciones').insert([{ 
            art√≠culo_id: a.id, 
            tipo_reaccion: 'üí¨', 
            comentario_texto: `DE: ${n} (${e}) | SUSCRITO: ${suscrito} | MENSAJE: ${t}` 
        }]);

        // 2. REGISTRO EN LISTA DE ACTIVIDAD (Si acept√≥)
        if(suscrito) {
            await _supabase.from('sinapsis_registros').insert([{ nombre: n, email: e, institucion: "Lector/Interviniente" }]);
        }

        if(!err1) {
            // 3. CANAL DE COMUNICACI√ìN (Fix para caracteres especiales)
            const titSafe = a.Titulo.split(':')[0].substring(0,40);
            const canal = a.contacto_link || "mailto:redaccion@sinapsis.com";
            const cuerpo = `Estimado Investigador ${a.Autor},\n\nSoy ${n} (${e}). Le contacto desde Sinapsis sobre su obra "${titSafe}":\n\n"${t}"`;
            
            const linkFinal = canal.includes('mailto') 
                ? `${canal}?subject=SINAPSIS: ${encodeURIComponent(titSafe)}&body=${encodeURIComponent(cuerpo)}` 
                : `${canal}?text=${encodeURIComponent(cuerpo)}`;
            
            window.location.href = linkFinal;
            
            alert("Aporte registrado en el B√∫nker. Se ha abierto el canal de contacto.");
            cerrar();
        } else {
            alert("Error de sincronizaci√≥n con el B√∫nker.");
        }
    }

    async function registrarSimposio() {
        const n = document.getElementById('rn').value;
        const e = document.getElementById('re').value;
        const i = document.getElementById('ri').value;
        if(!n || !e) return alert("Datos obligatorios.");

        const { error } = await _supabase.from('sinapsis_registros').insert([{ nombre:n, email:e, institucion:i }]);
        if(!error) {
            document.getElementById('area-reg').innerHTML = `
                <div style="background:rgba(88,166,255,0.1); padding:20px; border-left:4px solid var(--accent);">
                    <h3 style="color:var(--accent); margin:0;">Inscripci√≥n Exitosa</h3>
                    <p style="margin:5px 0 0; font-size:0.9em;">Bienvenido a la red de inteligencia Sinapsis.</p>
                </div>`;
        }
    }

    async function reaccionar(id, p, t) {
        // Aseg√∫rate de que la columna se llame 'art√≠culo_id' en Supabase
        await _supabase.from('sinapsis_reacciones').insert([{ art√≠culo_id: id, parrafo_index: p, tipo_reaccion: t }]);
        alert("Se√±al registrada.");
    }

    function cerrar() { 
        document.getElementById('modalArticulo').style.display='none'; 
        document.body.style.overflow='auto'; 
    }

    function accesoBunker() { 
        const pass = prompt("ACCESO RESTRINGIDO. CLAVE:");
        if(pass === "admin123") window.location.href = "dashboard.html"; 
    }
    
    // INICIO DE SISTEMA
    cargar();
</script>
</body>
</html>
