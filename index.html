<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinapsis: Umbral de la Estrategia Asim√©trica</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --blue: #58a6ff; --orange: #f0883e; --silver: #c9d1d9; --alert: #ff4444;
        }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: var(--silver); 
            margin: 0; 
            padding: 0;
        }
        
        header { 
            background: #000; 
            padding: 50px 20px; 
            text-align: center; 
            border-bottom: 1px solid #30363d; 
            position: relative; 
        }
        
        .search-box { 
            width: 90%; 
            max-width: 600px; 
            padding: 12px 20px; 
            border-radius: 20px; 
            border: 1px solid var(--blue); 
            background: #111; 
            color: #fff; 
            margin-top: 20px;
        }

        /* Enlace al Dashboard */
        .dashboard-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--orange);
            text-decoration: none;
            font-size: 0.9em;
            background: rgba(240, 136, 62, 0.1);
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid var(--orange);
            transition: all 0.3s;
            z-index: 100;
        }
        .dashboard-link:hover {
            background: rgba(240, 136, 62, 0.3);
            transform: scale(1.05);
        }

        /* SECCI√ìN REGISTRO */
        #seccion-registro { 
            background: linear-gradient(90deg, #000, #161b22); 
            padding: 40px 20px; 
            text-align: center; 
            border-bottom: 2px solid var(--orange);
            margin: 0 auto;
            max-width: 1200px;
        }
        .form-registro { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            flex-wrap: wrap; 
            margin-top: 20px; 
        }
        .form-registro input { 
            padding: 12px; 
            border-radius: 5px; 
            border: 1px solid #333; 
            background: #000; 
            color: #fff; 
            width: 250px; 
            box-sizing: border-box;
        }
        .btn-registro { 
            background: var(--orange); 
            color: #000; 
            border: none; 
            padding: 12px 30px; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 5px; 
            transition: 0.3s; 
            margin-top: 10px;
        }
        .btn-registro:hover { 
            background: #fff; 
            transform: scale(1.05); 
        }

        .media-station {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px;
            background: var(--card); 
            border: 1px solid var(--blue);
            padding: 20px; 
            border-radius: 15px; 
            margin: 30px auto;
            max-width: 1200px; 
            width: 90%;
        }
        
        @media (min-width: 900px) { 
            .media-station { 
                grid-template-columns: 2fr 1fr; 
            } 
        }
        
        .player-container { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 16 / 9; 
            background: #000; 
            border-radius: 8px; 
            overflow: hidden; 
        }

        .container { 
            padding: 40px 20px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 30px; 
            max-width: 1400px; 
            margin: auto; 
        }

        .card {
            background: var(--card); 
            border-radius: 12px; 
            overflow: hidden;
            border: 1px solid #30363d; 
            cursor: pointer; 
            transition: 0.3s;
            position: relative; 
            height: 420px; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-end;
        }
        .card:hover { 
            transform: translateY(-10px); 
            border-color: var(--blue); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .card-info { 
            background: linear-gradient(to top, rgba(13,17,23,1) 40%, rgba(13,17,23,0.7) 80%, transparent); 
            padding: 20px; 
            width: 100%; 
            box-sizing: border-box;
        }
        .avatar-real { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            border: 2px solid var(--blue); 
            object-fit: cover; 
            background: #000; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 1000; 
            overflow-y: auto;
        }
        .modal-content { 
            background: var(--bg); 
            width: 90%; 
            max-width: 900px; 
            margin: 50px auto; 
            padding: 40px; 
            border-radius: 15px; 
            max-height: 85vh;
            overflow-y: auto; 
            border: 1px solid var(--blue);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .btn-reaction { 
            background: none; 
            border: 1px solid #333; 
            color: #fff; 
            padding: 8px 15px; 
            cursor: pointer; 
            border-radius: 5px; 
            margin-right: 5px; 
            margin-top: 10px;
            transition: 0.3s;
        }
        .btn-reaction:hover { 
            border-color: var(--orange); 
            background: rgba(240, 136, 62, 0.1);
        }

        /* CAJA DE DI√ÅLOGO CR√çTICO */
        .caja-dialogo { 
            background: #0a0c10; 
            border: 1px solid var(--orange); 
            padding: 25px; 
            border-radius: 10px; 
            margin-top: 40px; 
            box-shadow: 0 5px 15px rgba(240, 136, 62, 0.1);
        }
        .btn-canal { 
            padding: 10px 20px; 
            border-radius: 5px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            margin-right: 10px; 
            margin-bottom: 10px;
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.3s;
        }
        .btn-canal:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
        }
        .whatsapp { background: #25d366; color: #000; }
        .email { background: var(--blue); color: #000; }
        .telegram { background: #0088cc; color: #000; }

        #mensaje-exito { 
            display: none; 
            color: var(--orange); 
            font-weight: bold; 
            margin-top: 20px; 
            padding: 15px;
            background: rgba(240, 136, 62, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(240, 136, 62, 0.3);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card);
            border: 1px solid var(--orange);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
            max-width: 350px;
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Mensajes de carga y error */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--blue);
        }
        .error-message {
            text-align: center;
            padding: 40px;
            color: var(--alert);
            border: 1px solid var(--alert);
            border-radius: 10px;
            margin: 20px;
            background: rgba(255, 68, 68, 0.1);
        }
    </style>
</head>
<body>

<!-- Enlace al Dashboard -->
<a href="dashboard.html" class="dashboard-link">
    <i class="fas fa-shield-alt"></i> B√∫nker de Inteligencia
</a>

<header>
    <h1 style="color:var(--blue); letter-spacing: 5px; margin: 0;">SINAPSIS</h1>
    <p style="color:var(--orange); margin: 10px 0 0;">Revista de Estrategia Asim√©trica y Pensamiento Cr√≠tico</p>
    <input type="text" class="search-box" placeholder="Buscar en el umbral..." id="searchInput">
</header>

<section id="seccion-registro">
    <h2 style="color:#fff; margin-top: 0;">SIMPOSIO INTERNACIONAL 2026</h2>
    <p style="max-width: 800px; margin: 0 auto;">Reg√≠strese para activar los canales de di√°logo cr√≠tico con los autores y participar en la definici√≥n de temas estrat√©gicos.</p>
    <div class="form-registro" id="form-reg">
        <input type="text" id="reg-nombre" placeholder="Nombre y Apellido" required>
        <input type="email" id="reg-email" placeholder="Correo Electr√≥nico" required>
        <input type="text" id="reg-inst" placeholder="Instituci√≥n / Afiliaci√≥n">
        <button class="btn-registro" onclick="registrarUsuario()">ACTIVAR ACCESO</button>
    </div>
    <div id="mensaje-exito">
        <i class="fas fa-check-circle"></i> Identidad verificada. Canales de comunicaci√≥n activos.
        <br><small>Sus intervenciones configurar√°n los temas del Simposio 2026</small>
    </div>
</section>

<section class="media-station">
    <div class="player-container">
        <iframe id="mainVideo" width="100%" height="100%" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="media-sidebar">
        <h2 style="color:var(--orange); margin-top:0;">üéôÔ∏è Interferencia Semanal</h2>
        <p style="font-size:0.9em;">Di√°logos con los autores y exploraciones audiovisuales.</p>
        <div style="margin-top:20px;">
            <p>üéß Podcast del Simposio:</p>
            <audio id="mainPodcast" controls style="width:100%;"></audio>
        </div>
    </div>
</section>

<div class="container" id="grid-articulos">
    <div class="loading" id="loadingArticles">
        <i class="fas fa-spinner fa-spin"></i> Cargando art√≠culos...
    </div>
</div>

<!-- Notificaci√≥n flotante -->
<div class="notification" id="globalNotification">
    <span id="notificationText"></span>
</div>

<div id="modalArticulo" class="modal">
    <div class="modal-content">
        <button onclick="cerrarLectura()" style="float:right; background:none; border:none; color:var(--orange); font-size:24px; cursor:pointer; padding: 5px 10px;">&times;</button>
        <div id="contenidoArticulo"></div>
    </div>
</div>

<script>
    // ==================== CONFIGURACI√ìN SUPABASE ====================
    const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk';
    
    // Verificar que Supabase est√© disponible
    if (typeof supabase === 'undefined') {
        document.getElementById('grid-articulos').innerHTML = `
            <div class="error-message">
                <h3>Error de configuraci√≥n</h3>
                <p>No se pudo cargar la biblioteca Supabase. Verifica tu conexi√≥n a internet.</p>
            </div>
        `;
        throw new Error("Supabase no est√° disponible");
    }
    
    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    
    // Variable global para usuario
    let usuarioActual = JSON.parse(localStorage.getItem('sinapsis_user')) || null;
    
    // ==================== FUNCIONES DE UTILIDAD ====================
    function mostrarNotificacion(mensaje, tipo = 'info') {
        const notification = document.getElementById('globalNotification');
        const text = document.getElementById('notificationText');
        
        text.textContent = mensaje;
        notification.style.display = 'block';
        notification.style.borderColor = tipo === 'error' ? 'var(--alert)' : 
                                       tipo === 'success' ? 'var(--orange)' : 'var(--blue)';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 4000);
    }
    
    function mostrarError(mensaje) {
        document.getElementById('grid-articulos').innerHTML = `
            <div class="error-message" style="grid-column: 1/-1;">
                <h3>Error al cargar contenido</h3>
                <p>${mensaje}</p>
                <button onclick="obtenerArticulos()" style="margin-top: 15px; padding: 10px 20px; background: var(--orange); color: black; border: none; border-radius: 5px; cursor: pointer;">
                    Reintentar
                </button>
            </div>
        `;
    }
    
    // Funci√≥n para escapar strings para HTML
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    // ==================== FUNCIONES PRINCIPALES ====================
    window.onload = async () => {
        console.log("üîÑ Iniciando aplicaci√≥n Sinapsis...");
        
        // Configurar usuario si ya est√° registrado
        if(usuarioActual) {
            document.getElementById('form-reg').style.display = 'none';
            document.getElementById('mensaje-exito').style.display = 'block';
            console.log("üë§ Usuario encontrado:", usuarioActual.nombre);
        }
        
        // Cargar art√≠culos
        await obtenerArticulos();
        
        // Configurar b√∫squeda
        document.getElementById('searchInput').addEventListener('input', buscarArticulos);
        
        console.log("‚úÖ Aplicaci√≥n iniciada correctamente");
    };
    
    async function registrarUsuario() {
        const nombre = document.getElementById('reg-nombre').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const inst = document.getElementById('reg-inst').value.trim();
        
        if(!nombre || !email) {
            mostrarNotificacion("Por favor complete nombre y correo electr√≥nico", 'error');
            return;
        }
        
        if(!email.includes('@')) {
            mostrarNotificacion("Ingrese un correo electr√≥nico v√°lido", 'error');
            return;
        }
        
        try {
            console.log("üìù Registrando usuario:", nombre);
            
            // 1. Guardar en sinapsis_registros
            const { error: errorRegistro } = await _supabase
                .from('sinapsis_registros')
                .insert([{ 
                    nombre: nombre, 
                    email: email, 
                    institucion: inst || null 
                }]);
            
            if (errorRegistro) {
                if (errorRegistro.code === '23505') {
                    // Usuario ya existe
                    mostrarNotificacion("Este correo ya est√° registrado. Acceso activado.", 'info');
                } else {
                    throw errorRegistro;
                }
            }
            
            // 2. Guardar en contactos_simposio (para eventos)
            const { error: errorContacto } = await _supabase
                .from('contactos_simposio')
                .upsert({
                    nombre: nombre,
                    email: email,
                    institucion: inst || null,
                    primera_intervencion: new Date().toISOString(),
                    ultima_intervencion: new Date().toISOString(),
                    interes_simposio: true,
                    fecha_registro: new Date().toISOString()
                }, { 
                    onConflict: 'email',
                    ignoreDuplicates: false 
                });
            
            if (errorContacto) console.warn("‚ö†Ô∏è Error en contactos_simposio:", errorContacto);
            
            // 3. Guardar en dashboard_intervenciones
            const { error: errorDashboard } = await _supabase
                .from('dashboard_intervenciones')
                .insert([{
                    usuario_nombre: nombre,
                    usuario_email: email,
                    usuario_institucion: inst || null,
                    tipo_accion: 'registro',
                    contenido: 'Registro en el Simposio 2026',
                    fecha: new Date().toISOString(),
                    metadata: {
                        fuente: 'formulario_registro',
                        para_pdf: true
                    }
                }]);
            
            if (errorDashboard) console.warn("‚ö†Ô∏è Error en dashboard_intervenciones:", errorDashboard);
            
            // 4. Actualizar estado local y UI
            usuarioActual = { nombre: nombre, email: email, institucion: inst };
            localStorage.setItem('sinapsis_user', JSON.stringify(usuarioActual));
            
            document.getElementById('form-reg').style.display = 'none';
            document.getElementById('mensaje-exito').style.display = 'block';
            
            mostrarNotificacion("‚úÖ Registro exitoso. Acceso concedido al Simposio 2026", 'success');
            
        } catch (error) {
            console.error("‚ùå Error en registro:", error);
            mostrarNotificacion(`Error: ${error.message}`, 'error');
        }
    }
    
    async function obtenerArticulos() {
        try {
            console.log("üìö Solicitando art√≠culos desde Supabase...");
            
            const { data, error } = await _supabase
                .from('articulos')
                .select('*')
                .order('id', { ascending: false });
            
            if (error) {
                console.error("‚ùå Error en consulta:", error);
                throw error;
            }
            
            console.log(`‚úÖ ${data ? data.length : 0} art√≠culos recibidos`);
            
            if (!data || data.length === 0) {
                mostrarError("No se encontraron art√≠culos en la base de datos.");
                return;
            }
            
            dibujarCards(data);
            
        } catch (error) {
            console.error("‚ùå Error cargando art√≠culos:", error);
            mostrarError(`Error al conectar con la base de datos: ${error.message}`);
        }
    }
    
    function dibujarCards(articulos) {
        const grid = document.getElementById('grid-articulos');
        
        // Limpiar mensaje de carga
        grid.innerHTML = '';
        
        if (!articulos || articulos.length === 0) {
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                    <h3 style="color: var(--orange)">No hay art√≠culos publicados</h3>
                    <p>Pr√≥ximamente se publicar√°n nuevos contenidos.</p>
                </div>
            `;
            return;
        }
        
        articulos.forEach(art => {
            // Preparar datos
            const titulo = art.titulo || 'Sin t√≠tulo';
            const autor = art.autor || 'Autor desconocido';
            const afiliacion = art.afiliacion || 'Sin afiliaci√≥n';
            const portada = art.portada_url || 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&w=800';
            const fotoAutor = art.autor_foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(autor)}&background=random&color=fff`;
            
            // Crear card
            const card = document.createElement('div');
            card.className = 'card';
            card.style.background = `url('${portada}') center/cover no-repeat`;
            
            card.innerHTML = `
                <div class="card-info">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <img src="${fotoAutor}" class="avatar-real" 
                             onerror="this.src='https://ui-avatars.com/api/?name=A&background=333&color=fff'">
                        <small style="color:var(--blue); font-weight:bold;">${escapeHtml(autor)}</small>
                    </div>
                    <small style="color:var(--orange); font-weight:bold; text-transform:uppercase;">${escapeHtml(afiliacion)}</small>
                    <h3 style="margin: 5px 0; color:#fff; font-size:1.4em; line-height:1.3;">${escapeHtml(titulo)}</h3>
                </div>
            `;
            
            // Agregar evento click usando addEventListener para evitar problemas de sintaxis
            card.addEventListener('click', () => abrirLectura(art));
            
            grid.appendChild(card);
        });
        
        console.log(`üé® ${articulos.length} tarjetas dibujadas`);
    }
    
    function buscarArticulos() {
        const termino = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.querySelectorAll('.card');
        
        cards.forEach(card => {
            const titulo = card.querySelector('h3').textContent.toLowerCase();
            const autor = card.querySelector('small[style*="color:var(--blue)"]').textContent.toLowerCase();
            const afiliacion = card.querySelector('small[style*="color:var(--orange)"]').textContent.toLowerCase();
            
            const coincide = titulo.includes(termino) || autor.includes(termino) || afiliacion.includes(termino);
            card.style.display = coincide ? 'flex' : 'none';
        });
    }
    
    function abrirLectura(art) {
        console.log("üìñ Abriendo art√≠culo:", art.titulo);
        
        const modal = document.getElementById('modalArticulo');
        const contenido = document.getElementById('contenidoArticulo');
        
        // Preparar contenido del art√≠culo
        const titulo = art.titulo || 'Sin t√≠tulo';
        const autor = art.autor || 'Autor desconocido';
        const afiliacion = art.afiliacion || 'Sin afiliaci√≥n';
        const doi = art.doi || 'No disponible';
        const contacto = art.contacto_link || '';
        const fotoAutor = art.autor_foto_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(autor)}&background=random&color=fff`;
        
        // Dividir contenido en p√°rrafos
        let htmlParrafos = '';
        if (art.contenido) {
            const parrafos = art.contenido.split('\n').filter(p => p.trim());
            htmlParrafos = parrafos.map((parrafo, index) => {
                // Usar data attributes en lugar de onclick para evitar problemas de sintaxis
                return `
                    <div class="parrafo-container" style="margin-bottom: 25px;">
                        <p style="line-height: 1.8; font-size: 1.1em; text-align: justify;">${escapeHtml(parrafo)}</p>
                        <div class="reacciones">
                            <button class="btn-reaction" data-articulo-id="${art.id}" data-parrafo-index="${index}" data-tipo="üí°">
                                üí° Inter√©s
                            </button>
                            <button class="btn-reaction" data-articulo-id="${art.id}" data-parrafo-index="${index}" data-tipo="‚öñÔ∏è">
                                ‚öñÔ∏è Debate
                            </button>
                            <button class="btn-reaction" data-articulo-id="${art.id}" data-parrafo-index="${index}" data-tipo="‚ùì">
                                ‚ùì Duda
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            htmlParrafos = '<p style="color: var(--silver); font-style: italic;">Este art√≠culo no tiene contenido disponible.</p>';
        }
        
        // Caja de di√°logo - usar data attributes en lugar de onclick
        const buzonInteraccion = `
            <div class="caja-dialogo" data-articulo-id="${art.id}">
                <h3 style="color:var(--orange); margin-top: 0;">üéôÔ∏è Di√°logo Cr√≠tico con ${escapeHtml(autor)}</h3>
                <p>Env√≠e su tesis o pregunta sobre este art√≠culo para el Simposio 2026</p>
                
                <textarea id="texto-tesis-${art.id}" placeholder="Escriba aqu√≠ su tesis o intervenci√≥n cr√≠tica..." 
                          style="width:100%; height: 120px; background:#000; color:#fff; border:1px solid #333; padding:12px; margin-top:10px; border-radius: 5px; font-family: inherit; resize: vertical;"></textarea>
                
                <div style="margin-top: 20px;">
                    <button class="btn-canal email" data-articulo-id="${art.id}" data-canal="email">
                        <i class="fas fa-envelope"></i> ENVIAR POR CORREO
                    </button>
                    <button class="btn-canal whatsapp" data-articulo-id="${art.id}" data-canal="whatsapp">
                        <i class="fab fa-whatsapp"></i> WHATSAPP
                    </button>
                    <button class="btn-canal telegram" data-articulo-id="${art.id}" data-canal="telegram">
                        <i class="fab fa-telegram"></i> TELEGRAM
                    </button>
                </div>
                
                <div style="margin-top: 15px; font-size: 0.9em; color: #8b949e;">
                    <p><i class="fas fa-chart-line"></i> Su intervenci√≥n ser√° incluida en el an√°lisis del Simposio 2026</p>
                    <p><i class="fas fa-fingerprint"></i> DOI: ${escapeHtml(doi)}</p>
                </div>
            </div>
        `;
        
        // Contenido completo del modal
        contenido.innerHTML = `
            <h1 style="color:var(--blue); margin-top: 0;">${escapeHtml(titulo)}</h1>
            
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #30363d;">
                <img src="${fotoAutor}" 
                     style="width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--orange); object-fit: cover;"
                     onerror="this.src='https://ui-avatars.com/api/?name=A&background=333&color=fff'">
                <div>
                    <h3 style="color:var(--orange); margin: 0;">${escapeHtml(autor)}</h3>
                    <p style="margin: 5px 0 0; color:var(--silver);">${escapeHtml(afiliacion)}</p>
                </div>
            </div>
            
            ${htmlParrafos}
            
            ${buzonInteraccion}
        `;
        
        // Configurar event listeners para los botones de reacci√≥n
        contenido.querySelectorAll('.btn-reaction[data-articulo-id]').forEach(btn => {
            btn.addEventListener('click', function() {
                const articuloId = this.getAttribute('data-articulo-id');
                const parrafoIndex = this.getAttribute('data-parrafo-index');
                const tipo = this.getAttribute('data-tipo');
                
                reaccionar(articuloId, parrafoIndex, tipo, titulo, autor);
            });
        });
        
        // Configurar event listeners para los botones de canal
        contenido.querySelectorAll('.btn-canal[data-articulo-id]').forEach(btn => {
            btn.addEventListener('click', function() {
                const articuloId = this.getAttribute('data-articulo-id');
                const canal = this.getAttribute('data-canal');
                const textarea = document.getElementById(`texto-tesis-${articuloId}`);
                
                if (textarea) {
                    enviarTesis(articuloId, autor, titulo, canal, contacto, textarea);
                }
            });
        });
        
        // Mostrar modal
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        console.log("‚úÖ Modal de art√≠culo abierto");
    }
    
    async function enviarTesis(articuloId, autor, titulo, canal, contactoLink = '', textareaElement) {
        if (!usuarioActual) {
            mostrarNotificacion("Debe registrarse primero para participar en el di√°logo", 'error');
            document.getElementById('seccion-registro').scrollIntoView({ behavior: 'smooth' });
            return;
        }
        
        const mensaje = textareaElement.value.trim();
        
        if (!mensaje || mensaje.length < 10) {
            mostrarNotificacion("Escriba una intervenci√≥n significativa (m√≠nimo 10 caracteres)", 'error');
            textareaElement.focus();
            return;
        }
        
        if (mensaje.length > 2000) {
            mostrarNotificacion("El mensaje es demasiado largo (m√°ximo 2000 caracteres)", 'error');
            return;
        }
        
        try {
            console.log(`üì§ Enviando tesis para art√≠culo ${articuloId} por ${canal}`);
            
            // 1. Guardar en sinapsis_reacciones
            const { error: errorReaccion } = await _supabase
                .from('sinapsis_reacciones')
                .insert([{
                    articulo_id: articuloId,
                    tipo_reaccion: 'üí¨',
                    comentario_texto: `DE: ${usuarioActual.nombre} (${usuarioActual.email}) | MSG: ${mensaje}`,
                    usuario_nombre: usuarioActual.nombre,
                    usuario_email: usuarioActual.email,
                    canal: canal
                }]);
            
            if (errorReaccion) throw errorReaccion;
            
            // 2. Guardar en dashboard_intervenciones
            const { error: errorDashboard } = await _supabase
                .from('dashboard_intervenciones')
                .insert([{
                    usuario_nombre: usuarioActual.nombre,
                    usuario_email: usuarioActual.email,
                    usuario_institucion: usuarioActual.institucion || null,
                    articulo_id: articuloId,
                    articulo_titulo: titulo,
                    articulo_autor: autor,
                    tipo_accion: 'tesis',
                    contenido: mensaje,
                    canal_usado: canal,
                    fecha: new Date().toISOString(),
                    metadata: {
                        para_pdf: true,
                        simposio_tema: true,
                        prioridad: 'media',
                        longitud_caracteres: mensaje.length
                    }
                }]);
            
            if (errorDashboard) console.warn("‚ö†Ô∏è Error en dashboard_intervenciones:", errorDashboard);
            
            // 3. Actualizar contactos_simposio
            const { data: contactoExistente } = await _supabase
                .from('contactos_simposio')
                .select('articulos_intervenidos, total_intervenciones')
                .eq('email', usuarioActual.email)
                .single();
            
            let articulosIntervenidos = contactoExistente?.articulos_intervenidos || [];
            if (!articulosIntervenidos.includes(parseInt(articuloId))) {
                articulosIntervenidos.push(parseInt(articuloId));
            }
            
            const totalIntervenciones = (contactoExistente?.total_intervenciones || 0) + 1;
            
            await _supabase
                .from('contactos_simposio')
                .update({
                    articulos_intervenidos: articulosIntervenidos,
                    total_intervenciones: totalIntervenciones,
                    ultima_intervencion: new Date().toISOString()
                })
                .eq('email', usuarioActual.email);
            
            // 4. Preparar y abrir canal de comunicaci√≥n
            const textoParaEnviar = `Tesis Sinapsis 2026

De: ${usuarioActual.nombre}
Correo: ${usuarioActual.email}
Instituci√≥n: ${usuarioActual.institucion || 'No especificada'}

Art√≠culo: "${titulo}"
Autor: ${autor}

Intervenci√≥n cr√≠tica:
"${mensaje}"

---
Enviado desde Sinapsis: Umbral de la Estrategia Asim√©trica
Esta intervenci√≥n ser√° considerada para el Simposio Internacional 2026`;
            
            // Abrir el canal correspondiente
            if (canal === 'email') {
                const mailtoLink = contactoLink && contactoLink.includes('@') 
                    ? contactoLink 
                    : '';
                window.location.href = `mailto:${mailtoLink}?subject=Tesis sobre "${titulo}"&body=${encodeURIComponent(textoParaEnviar)}`;
            } else if (canal === 'whatsapp') {
                window.open(`https://wa.me/?text=${encodeURIComponent(textoParaEnviar)}`, '_blank');
            } else if (canal === 'telegram') {
                window.open(`https://t.me/share/url?url=&text=${encodeURIComponent(textoParaEnviar)}`, '_blank');
            }
            
            // 5. Mostrar confirmaci√≥n y limpiar
            mostrarNotificacion("‚úÖ Tesis registrada para el an√°lisis del Simposio 2026", 'success');
            textareaElement.value = '';
            
            // Cerrar modal despu√©s de 2 segundos
            setTimeout(() => {
                cerrarLectura();
            }, 2000);
            
        } catch (error) {
            console.error("‚ùå Error enviando tesis:", error);
            mostrarNotificacion(`Error: ${error.message}`, 'error');
        }
    }
    
    async function reaccionar(articuloId, parrafoIndex, tipo, titulo, autor) {
        if (!usuarioActual) {
            mostrarNotificacion("Reg√≠strese para registrar sus reacciones", 'error');
            return;
        }
        
        try {
            console.log(`üîÑ Registrando reacci√≥n ${tipo} en art√≠culo ${articuloId}, p√°rrafo ${parrafoIndex}`);
            
            // 1. Guardar en sinapsis_reacciones
            const { error: errorReaccion } = await _supabase
                .from('sinapsis_reacciones')
                .insert([{
                    articulo_id: parseInt(articuloId),
                    tipo_reaccion: tipo,
                    parrafo_index: parseInt(parrafoIndex),
                    usuario_nombre: usuarioActual.nombre,
                    usuario_email: usuarioActual.email
                }]);
            
            if (errorReaccion) throw errorReaccion;
            
            // 2. Guardar en dashboard_intervenciones
            const tipoTexto = tipo === 'üí°' ? 'Inter√©s' : tipo === '‚öñÔ∏è' ? 'Debate' : 'Duda';
            
            const { error: errorDashboard } = await _supabase
                .from('dashboard_intervenciones')
                .insert([{
                    usuario_nombre: usuarioActual.nombre,
                    usuario_email: usuarioActual.email,
                    usuario_institucion: usuarioActual.institucion || null,
                    articulo_id: parseInt(articuloId),
                    articulo_titulo: titulo,
                    articulo_autor: autor,
                    tipo_accion: 'reaccion',
                    contenido: tipoTexto,
                    fecha: new Date().toISOString(),
                    metadata: {
                        parrafo_index: parseInt(parrafoIndex),
                        emoji: tipo,
                        para_pdf: false
                    }
                }]);
            
            if (errorDashboard) console.warn("‚ö†Ô∏è Error en dashboard_intervenciones:", errorDashboard);
            
            mostrarNotificacion(`‚úÖ Reacci√≥n registrada: ${tipoTexto}`, 'success');
            
        } catch (error) {
            console.error("‚ùå Error registrando reacci√≥n:", error);
            mostrarNotificacion("Error al registrar reacci√≥n", 'error');
        }
    }
    
    function cerrarLectura() {
        document.getElementById('modalArticulo').style.display = 'none';
        document.body.style.overflow = 'auto';
        console.log("üìï Modal cerrado");
    }
</script>
</body>
</html>
