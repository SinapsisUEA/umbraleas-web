<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINAPSIS | Inteligencia Estrat√©gica</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #05070a; --panel: #0d1117; --blue: #58a6ff; --orange: #f0883e; --silver: #c9d1d9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--silver); margin: 0; }
        
        header { background: #000; padding: 40px; text-align: center; border-bottom: 2px solid #333; }
        .brand { font-size: 3em; letter-spacing: 5px; color: var(--blue); font-weight: bold; }
        
        /* Estaci√≥n Multimedia Recuperada */
        .media-station { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; padding: 40px; max-width: 1200px; margin: auto; 
        }
        .media-card { background: var(--panel); padding: 20px; border: 1px solid #333; border-radius: 8px; }

        /* Art√≠culos */
        .grid { max-width: 1200px; margin: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; padding: 20px; }
        .card { background: var(--panel); border: 1px solid #333; cursor: pointer; height: 400px; position: relative; overflow: hidden; border-radius: 8px; }
        .card-img { position: absolute; width: 100%; height: 100%; opacity: 0.4; background-size: cover !important; }
        .card-body { position: relative; z-index: 2; padding: 25px; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; background: linear-gradient(transparent, #000); }

        /* Modal y Reacciones Corregidas */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; }
        .modal-content { background: var(--bg); width: 90%; max-width: 900px; margin: 5vh auto; padding: 40px; border: 1px solid #333; }
        .parrafo-bloque { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 25px; }
        .texto-p { flex: 1; line-height: 1.8; text-align: justify; margin: 0; }
        .btns-reaccion { display: flex; flex-direction: column; gap: 5px; }
        .btn-r { background: #111; border: 1px solid #333; color: #888; padding: 5px 10px; cursor: pointer; font-size: 0.8em; }
        .btn-r:hover { border-color: var(--blue); color: #fff; }

        /* Formulario Simposio */
        .simposium-box { border: 1px solid var(--orange); padding: 30px; max-width: 1100px; margin: 40px auto; background: #000; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        input { padding: 12px; background: #111; border: 1px solid #333; color: #fff; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <div class="brand">SINAPSIS</div>
    <p style="color:var(--orange); font-weight:bold; letter-spacing:2px;">Umbral de la Estrategia Asim√©trica | 2026</p>
</header>

<section class="media-station">
    <div class="media-card">
        <h3><i class="fas fa-video"></i> Canal de An√°lisis</h3>
        <iframe width="100%" height="200" src="https://www.youtube.com/embed/LIVE_ID" frameborder="0" allowfullscreen></iframe>
    </div>
    <div class="media-card">
        <h3><i class="fas fa-podcast"></i> Podcast Estrat√©gico</h3>
        <audio controls style="width:100%;"><source src="URL_PODCAST" type="audio/mpeg"></audio>
    </div>
</section>

<section class="simposium-box">
    <div>
        <h2 style="color:var(--orange)">SIMPOSIO INTERNACIONAL</h2>
        <p>Complete su ficha para la base de datos de inteligencia.</p>
    </div>
    <div id="reg-area">
        <input type="text" id="rn" placeholder="Nombre y Apellido" style="margin-bottom:10px;">
        <input type="email" id="re" placeholder="Correo Institucional" style="margin-bottom:10px;">
        <input type="text" id="ri" placeholder="Organismo / Entidad" style="margin-bottom:10px;">
        <button onclick="registrarSimposio()" style="width:100%; padding:15px; background:var(--orange); border:none; font-weight:bold; cursor:pointer;">INSCRIBIRSE</button>
    </div>
</section>

<div class="grid" id="grid-articulos"></div>

<div id="modalArticulo" class="modal">
    <div class="modal-content">
        <span onclick="cerrar()" style="float:right; cursor:pointer; color:var(--orange); font-weight:bold;">[ CERRAR ]</span>
        <div id="cont"></div>
    </div>
</div>

<script>
    const SB_URL = 'https://wajivhbldplztjvqudht.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhaml2aGJsZHBsenRqdnF1ZGh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MzkxNjQsImV4cCI6MjA4MzMxNTE2NH0.NyDC18RuIZGoH_Epnt1oCgMMxDMBhfoK-wdEKHU0rYk'; // Aseg√∫rate de usar la key correcta
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let localArt = [];

    async function cargar() {
        const { data } = await _supabase.from('articulos').select('*').order('id', { ascending: false });
        if (data) { localArt = data; dibujar(data); }
    }

    function dibujar(lista) {
        document.getElementById('grid-articulos').innerHTML = lista.map((a, i) => `
            <div class="card" onclick="abrir(${i})">
                <div class="card-img" style="background:url('${a.Imagen_URL}') center/cover;"></div>
                <div class="card-body">
                    <img src="${a.Avatar_URL}" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--blue);">
                    <h3 style="margin:10px 0 0;">${a.Titulo}</h3>
                    <small style="color:var(--blue)">Investigador: ${a.Autor}</small>
                </div>
            </div>
        `).join('');
    }

    function abrir(i) {
        const a = localArt[i];
        // Desglose corregido: P√°rrafos y botones alineados
        let pTotal = a.Contenido.split('\n').map((p, idx) => p.trim() ? `
            <div class="parrafo-bloque">
                <p class="texto-p">${p}</p>
                <div class="btns-reaccion">
                    <button class="btn-r" onclick="reaccionar(${a.id},${idx},'üí°')">üí°</button>
                    <button class="btn-r" onclick="reaccionar(${a.id},${idx},'‚ùì')">‚ùì</button>
                </div>
            </div>` : "").join('');

        const buzon = `
            <div style="background:var(--panel); padding:30px; border:1px solid var(--blue); margin-top:40px;">
                <h3><i class="fas fa-envelope"></i> Contactar al Investigador</h3>
                <input type="text" id="m-n" placeholder="Su Nombre" style="margin-bottom:10px;">
                <input type="email" id="m-e" placeholder="Su Correo" style="margin-bottom:10px;">
                <textarea id="m-t" placeholder="Propuesta..." style="width:100%; height:100px; background:#000; color:#fff; border:1px solid #333; padding:10px;"></textarea>
                <div style="margin-top:10px;"><input type="checkbox" id="chk" checked> Acepto registro en base de datos.</div>
                <button onclick="enviarFinal(${i})" style="width:100%; padding:15px; background:var(--blue); border:none; margin-top:15px; font-weight:bold; cursor:pointer;">ENVIAR MENSAJE</button>
            </div>
        `;

        document.getElementById('cont').innerHTML = `<h1>${a.Titulo}</h1><hr style="border:1px solid #333;">${pTotal}${buzon}`;
        document.getElementById('modalArticulo').style.display = 'block';
    }

    async function registrarSimposio() {
        const n = document.getElementById('rn').value;
        const e = document.getElementById('re').value;
        const i = document.getElementById('ri').value;
        const { error } = await _supabase.from('sinapsis_registros').insert([{ nombre: n, email: e, institucion: i }]);
        if(!error) {
            document.getElementById('reg-area').innerHTML = "<h3 style='color:var(--orange)'>‚úì Registro en Base de Datos Exitoso.</h3>";
        } else { alert("Error de conexi√≥n con el B√∫nker."); }
    }

    async function enviarFinal(i) {
        const a = localArt[i];
        const n = document.getElementById('m-n').value;
        const e = document.getElementById('m-e').value;
        const t = document.getElementById('m-t').value;
        if(!n || !e || !t) return alert("Complete los datos.");

        // Guardar en B√∫nker
        await _supabase.from('sinapsis_reacciones').insert([{ 
            art√≠culo_id: a.id, tipo_reaccion: 'üí¨', comentario_texto: `DE: ${n} (${e}) | MSG: ${t}` 
        }]);

        // WhatsApp / Email (Correcci√≥n de link inexistente)
        const msgWeb = encodeURIComponent(`Investigador ${a.Autor}, soy ${n}. Sobre su obra "${a.Titulo.substring(0,30)}": ${t}`);
        const link = a.contacto_link || "https://wa.me/TUNUMERO"; 
        
        // Si es WhatsApp, aseguramos el formato de la API
        if(link.includes('wa.me')) {
            window.open(`${link}?text=${msgWeb}`, '_blank');
        } else {
            window.location.href = `mailto:${link}?subject=Sinapsis&body=${msgWeb}`;
        }
    }

    async function reaccionar(id, p, t) {
        await _supabase.from('sinapsis_reacciones').insert([{ art√≠culo_id: id, parrafo_index: p, tipo_reaccion: t }]);
        alert("Se√±al registrada.");
    }

    function cerrar() { document.getElementById('modalArticulo').style.display='none'; }
    cargar();
</script>
</body>
</html>
